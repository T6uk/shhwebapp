{% extends "base.html" %}

{% block title %}{{ table_name }} - Data Viewer{% endblock %}

{% block head %}
<style>
    body {
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

    .edit-controls {
        display: none;
    }

    tr.editing .edit-controls {
        display: inline-block;
    }

    tr.editing .view-controls {
        display: none;
    }

    .table-container {
        overflow-x: auto;
        height: 100%;
        width: 100%;
    }

    .dataTables_length, .dataTables_filter {
        margin-bottom: 15px;
    }

    /* Highlight edited cells */
    td.edited {
        background-color: rgba(255, 255, 0, 0.1);
    }

    /* Make table header sticky */
    thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 2;
        white-space: nowrap;
    }

    /* Column groups dropdown */
    .column-group-dropdown {
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
    }

    .column-group-dropdown .dropdown-item {
        padding: 0.5rem 1rem;
    }

    .column-group-dropdown .dropdown-header {
        font-weight: bold;
        color: #212529;
        background-color: #f8f9fa;
    }

    .column-group-dropdown .dropdown-divider {
        margin: 0.2rem 0;
    }

    /* Toolbar */
    .toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .toolbar .btn-group {
        margin-right: 10px;
    }

    /* Advanced search */
    .advanced-search {
        width: 350px;
        position: relative;
    }

    .advanced-search .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .search-highlight {
        background-color: rgba(255, 255, 0, 0.4);
        border-radius: 2px;
        padding: 0 2px;
        transition: background-color 0.3s;
    }

    /* Tooltip for search shortcuts */
    .search-tooltip {
        position: absolute;
        top: 40px;
        right: 0;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        width: 250px;
        font-size: 0.85rem;
    }

    .advanced-search:hover .search-tooltip {
        display: block;
    }

    /* Search suggestions */
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
    }

    .search-suggestion-item {
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .search-suggestion-item:hover,
    .search-suggestion-item.active {
        background-color: #f8f9fa;
    }

    .search-suggestion-item:last-child {
        border-bottom: none;
    }

    .search-highlight.active {
        background-color: #ffc107;
        color: #000;
        font-weight: bold;
        border-radius: 3px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        outline: 2px solid #fd7e14;
        position: relative;
        z-index: 5;
    }

    .search-counter {
        min-width: 46px;
        text-align: center;
        font-weight: bold;
        transition: color 0.3s;
    }

    .search-counter.text-primary {
        color: #0d6efd !important;
    }

    .advanced-search input.searching {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
    }

    .active-view {
        background-color: #e9ecef;
        border-left: 4px solid #007bff;
    }

    .toolbar-row {
        margin-bottom: 8px;
    }

    #error-message {
        display: none;
        margin-bottom: 15px;
    }

    /* Virtual scrolling styles */
    div.dataTables_scrollBody {
        background: none !important;
    }

    /* Full height content */
    .content-wrapper {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .card {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin: 0 !important;
        border: none;
        border-radius: 0;
    }

    .card-body {
        flex: 1;
        padding: 0;
        overflow: hidden;
    }

    /* Loading overlay */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    /* Improved keyboard navigation indicator */
    #data-table:focus {
        outline: 2px solid rgba(13, 110, 253, 0.5);
        outline-offset: -2px;
    }

    /* Smoother animation for result navigation */
    #data-table tbody td {
        transition: background-color 0.2s;
    }

    /* Improve scrolling behavior */
    .dataTables_scrollBody {
        scroll-behavior: smooth;
    }

    /* Progress bar for search */
    .progress-bar-search {
        height: 3px;
        width: 0%;
        background-color: #0d6efd;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1100;
        transition: width 0.3s;
        display: none;
    }

    .search-filter-menu {
        width: 320px !important;
        font-size: 0.9rem;
    }

    .column-search-options {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 10px;
    }

    .column-search-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }

    .column-search-item label {
        margin-bottom: 0;
        margin-left: 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.85rem;
    }

    .search-help {
        margin-bottom: 0;
        padding-left: 0;
    }

    .search-help li {
        margin-bottom: 2px;
        font-size: 0.8rem;
    }

    .search-help code {
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        color: #d63384;
        font-size: 0.8rem;
    }

    .search-tag {
        display: inline-block;
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        margin-right: 4px;
        margin-bottom: 4px;
        border-radius: 16px;
        font-size: 0.8rem;
        transition: all 0.2s;
    }

    .search-tag:hover {
        background-color: #dee2e6;
    }

    .search-tag .remove-tag {
        margin-left: 4px;
        cursor: pointer;
    }

    .search-tag.column-tag {
        background-color: #cfe2ff;
        color: #084298;
    }

    .search-tag.phrase-tag {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .search-tag.exclude-tag {
        background-color: #f8d7da;
        color: #842029;
    }

    .search-highlight-exact {
        background-color: rgba(255, 193, 7, 0.5);
        font-weight: bold;
        border-radius: 2px;
        padding: 0 2px;
    }

    .search-options-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 15px;
        height: 15px;
        background-color: #0d6efd;
        border-radius: 50%;
        font-size: 9px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        display: none;
    }

    .has-active-filters .search-options-badge {
        display: flex;
    }

    .search-filter-btn {
        position: relative;
    }

    .highlight-row {
        background-color: rgba(13, 110, 253, 0.1) !important;
        transition: background-color 0.5s;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="card shadow">
        <div class="progress-bar-search" id="search-progress"></div>
        <div class="toolbar">
            <div class="row align-items-center">
                <div class="col">
                    <div class="input-group advanced-search">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle search-filter-btn" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel"></i>
                            </button>
                            <div class="dropdown-menu p-3 search-filter-menu" style="width: 320px;">
                                <h6 class="mb-2">Advanced Search Options</h6>
                                <div class="mb-3">
                                    <label class="form-label small">Search in columns:</label>
                                    <div id="column-search-options" class="column-search-options">
                                        <!-- Will be populated dynamically -->
                                        <div class="placeholder-text text-muted small">Loading columns...</div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">Search help:</label>
                                    <ul class="search-help small list-unstyled">
                                        <li><code>column:value</code> - Search specific column</li>
                                        <li><code>"exact phrase"</code> - Match exact phrase</li>
                                        <li><code>-word</code> - Exclude results with word</li>
                                    </ul>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-outline-secondary" id="clear-search-filters">Clear
                                        Filters
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="apply-search-filters">Apply</button>
                                </div>
                            </div>
                        </div>
                        <input type="text" id="advanced-search-input" class="form-control"
                               placeholder="Search data (syntax: column:value, &quot;exact phrase&quot;, -exclude)"
                               autocomplete="off"
                               aria-label="Search">
                        <button class="btn btn-outline-primary" type="button" id="search-btn">
                            <i class="bi bi-search"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="prev-result" disabled>
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="next-result" disabled>
                            <i class="bi bi-arrow-down"></i>
                        </button>
                        <span class="input-group-text search-counter" id="search-count">0/0</span>
                    </div>
                    <div class="search-suggestions" id="search-suggestions">
                        <!-- Search history will be populated here -->
                    </div>
                </div>
                <div class="col-auto d-flex flex-wrap">
                    <!-- Column Navigation -->
                    <div class="btn-group">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <i class="bi bi-columns"></i> Columns
                        </button>
                        <ul class="dropdown-menu column-group-dropdown">
                            {% for group_name, columns in column_groups.items() %}
                            <li><h6 class="dropdown-header">{{ group_name }}</h6></li>
                            {% for column in columns %}
                            <li><a class="dropdown-item column-link" href="#" data-column="{{ column.name }}">{{
                                column.name }}</a></li>
                            {% endfor %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            {% endfor %}
                            <li><a class="dropdown-item" href="#" id="column-settings-menu">Customize Columns...</a>
                            </li>
                        </ul>
                    </div>

                    <!-- Data Actions -->
                    <div class="btn-group">
                        <button id="refresh-btn" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button id="export-btn" class="btn btn-outline-success">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>

                    <!-- View Options -->
                    <div class="btn-group">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item view-option" href="#" data-view="all">Show All Columns</a></li>
                            <li><a class="dropdown-item view-option" href="#" data-view="main">Main Columns Only</a>
                            </li>
                            <li><a class="dropdown-item view-option" href="#" data-view="minimal">Minimal View</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" id="save-current-view">Save Current View</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message Area -->
        <div id="error-message" class="alert alert-danger mx-3"></div>

        <!-- Data Table -->
        <div class="card-body position-relative">
            <div id="loading-indicator" class="loading-overlay">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading data...</span>
                </div>
            </div>
            <div class="table-container">
                <table id="data-table" class="table table-striped table-bordered w-100" tabindex="0">
                    <thead>
                    <tr id="table-header">
                        <th>Loading...</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Loading data...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Column Settings Modal -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Column Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="column-filter" placeholder="Filter columns...">
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="column-settings-table">
                        <thead>
                        <tr>
                            <th>Visible</th>
                            <th>Column Name</th>
                            <th>Type</th>
                            <th>Order</th>
                        </tr>
                        </thead>
                        <tbody id="column-settings-body">
                        <!-- Column settings will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-column-settings">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- View Save Modal -->
<div class="modal fade" id="saveViewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="view-name" class="form-label">View Name</label>
                    <input type="text" class="form-control" id="view-name" placeholder="E.g., Financial Overview">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-save-view">Save View</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" id="export-csv">
                        <i class="bi bi-filetype-csv"></i> Export as CSV
                    </button>
                    <button type="button" class="btn btn-outline-success" id="export-excel">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export as Excel
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="export-json">
                        <i class="bi bi-filetype-json"></i> Export as JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let dataTable;
    let tableColumns = [];
    let visibleColumns = [];
    let allColumns = [];
    let MINIMAL_COLUMNS = ['id', 'võlgnik', 'toimiku_nr', 'nõude_suurus', 'staatus'];
    let MAIN_COLUMNS = [
        'id', 'võlgnik', 'toimiku_nr', 'toimiku_olek', 'sissenõudja_perenimi', 'sissenõudja_eesnimi',
        'võlgniku_perenimi', 'võlgniku_eesnimi', 'võlgniku_reg_isikukood', 'nõude_suurus',
        'tasud_ja_kulud_kokku', 'jäägid_kokku', 'staatus', 'märkused'
    ];
    let isTableInitializing = false;
    let customSearchFunction = null;
    let searchResults = [];
    let currentResultIndex = -1;
    let searchHistory = [];

    // Helper function to show errors
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        console.error(message);
    }

    // Helper function to hide errors
    function hideError() {
        const errorDiv = document.getElementById('error-message');
        errorDiv.style.display = 'none';
    }

    // Show/hide loading indicator
    function toggleLoading(show) {
        const indicator = document.getElementById('loading-indicator');
        indicator.style.display = show ? 'flex' : 'none';
    }

    // Check if element is in viewport
    function isInViewport(element) {
        const rect = element.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    // Helper function to escape regex special characters
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Function to disable navigation buttons
    function disableNavButtons() {
        const prevBtn = document.getElementById('prev-result');
        const nextBtn = document.getElementById('next-result');
        const searchCount = document.getElementById('search-count');
        const searchInput = document.getElementById('advanced-search-input');

        prevBtn.disabled = true;
        nextBtn.disabled = true;
        searchCount.textContent = '0/0';
        searchCount.classList.remove('text-primary');
        searchInput.classList.remove('border-primary');
    }

    // Optimize column visibility for performance
    function optimizeColumnVisibility() {
        // For very large tables, limit visible columns to improve initial load time
        if (allColumns.length > 50) {
            // If we have many columns, start with just the essential ones
            tableColumns.forEach(col => {
                col.visible = MINIMAL_COLUMNS.includes(col.name);
            });
            visibleColumns = tableColumns.filter(col => col.visible);
        }
    }

    // Initialize DataTable with first row data for columns
    async function initializeWithFirstRow() {
        if (isTableInitializing) return;
        isTableInitializing = true;

        try {
            hideError();
            toggleLoading(true);

            // Make a simple request to get the first row of data
            const response = await fetch(`/api/table/{{ table_name }}/data?length=1`);
            const data = await response.json();

            if (!data.data || data.data.length === 0) {
                showError('No data found in table. Unable to determine columns.');
                toggleLoading(false);
                isTableInitializing = false;
                return;
            }

            // Use the first row to determine columns
            const firstRow = data.data[0];

            // Get schema information
            const schemaResponse = await fetch(`/api/table/{{ table_name }}/schema`);
            const schemaData = await schemaResponse.json();

            // Create all columns array from schema if available, otherwise from first row
            if (schemaData.columns && schemaData.columns.length > 0) {
                allColumns = schemaData.columns;
            } else {
                allColumns = Object.keys(firstRow).map(key => {
                    const value = firstRow[key];
                    let dataType = 'text';

                    // Simple type detection
                    if (typeof value === 'number') {
                        dataType = 'number';
                    } else if (typeof value === 'boolean') {
                        dataType = 'boolean';
                    } else if (value instanceof Date) {
                        dataType = 'date';
                    }

                    return {
                        name: key,
                        type: dataType
                    };
                });
            }

            // If columns were previously stored, use those settings
            const savedColumns = JSON.parse(localStorage.getItem('taitur_columns'));

            if (savedColumns) {
                // Use saved column visibility and order
                tableColumns = savedColumns;

                // Make sure any new columns are included
                allColumns.forEach(colSchema => {
                    if (!tableColumns.find(col => col.name === colSchema.name)) {
                        tableColumns.push({
                            ...colSchema,
                            visible: MAIN_COLUMNS.includes(colSchema.name)
                        });
                    }
                });
            } else {
                // Set default visibility based on MAIN_COLUMNS
                tableColumns = allColumns.map(col => ({
                    ...col,
                    visible: MAIN_COLUMNS.includes(col.name)
                }));
            }

            // Optimize initial column visibility for performance
            optimizeColumnVisibility();

            // Update visible columns list
            visibleColumns = tableColumns.filter(col => col.visible);

            // Initialize table with these columns
            initializeTable();

        } catch (error) {
            showError(`Error fetching data: ${error.message}`);
            toggleLoading(false);
            isTableInitializing = false;
        }
    }

    function initializeTable() {

        let searchResults = [];
        let currentResultIndex = -1;
        let searchHistory = [];

        try {
            // Create column definitions for DataTables
            const columnDefs = visibleColumns.map(column => ({
                data: column.name,
                title: column.name,
                visible: true,
                render: function (data, type, row) {
                    // For ordering and searching, use the raw data
                    if (type === 'sort' || type === 'filter') {
                        return data;
                    }

                    // For display, handle different data types
                    if (type === 'display') {
                        if (data === null || data === undefined) return '';

                        // Handle different data types
                        if (column.type === 'boolean') {
                            return data ? 'Yes' : 'No';
                        }

                        // Format dates in a readable way
                        if (column.type === 'date' || column.type === 'datetime') {
                            if (data instanceof Date) {
                                return data.toLocaleDateString();
                            }

                            // Try to parse date strings
                            if (typeof data === 'string' && data.match(/^\d{4}-\d{2}-\d{2}/)) {
                                try {
                                    return new Date(data).toLocaleDateString();
                                } catch (e) {
                                    return data;
                                }
                            }
                        }

                        // Truncate long strings for better performance
                        if (typeof data === 'string' && data.length > 100) {
                            return `<span title="${data.replace(/"/g, '&quot;')}">${data.substring(0, 100)}...</span>`;
                        }

                        return data;
                    }

                    return data;
                }
            }));

            // Add actions column
            columnDefs.push({
                data: null,
                title: 'Actions',
                orderable: false,
                width: '100px',
                defaultContent: `
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary edit-btn view-controls">Edit</button>
                    <button class="btn btn-sm btn-success save-btn edit-controls">Save</button>
                    <button class="btn btn-sm btn-danger cancel-btn edit-controls">Cancel</button>
                </div>
            `
            });

            // Clear any existing DataTable
            if (dataTable) {
                dataTable.destroy();
            }

            // Reset custom search function
            customSearchFunction = null;

            // Recreate the table element to avoid any legacy issues
            const tableContainer = document.querySelector('.table-container');
            tableContainer.innerHTML = `
            <table id="data-table" class="table table-striped table-bordered w-100" tabindex="0">
                <thead>
                    <tr>
                    ${columnDefs.map(col => `<th>${col.title}</th>`).join('')}
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `;

            // Initialize DataTable with optimized settings
            dataTable = $('#data-table').DataTable({
                processing: false, // We'll handle our own processing indicator
                serverSide: true,
                deferRender: true,
                scrollCollapse: true,
                scroller: {
                    loadingIndicator: false, // Use our own loading indicator
                    displayBuffer: 20, // Increased buffer for smoother scrolling
                    rowHeight: 'auto', // Use auto row height for more accurate display
                    serverWait: 50 // Reduced server wait time
                },
                scrollY: 'calc(100vh - 60px)', // Adjust based on toolbar height
                scrollX: true,
                ajax: {
                    url: `/api/table/{{ table_name }}/data`,
                    beforeSend: function () {
                        if (!isTableInitializing) toggleLoading(true);
                    },
                    complete: function (data) {
                        toggleLoading(false);
                        isTableInitializing = false;

                        // If query time info is available, display it
                        if (data.responseJSON && data.responseJSON.query_time) {
                            console.log(`Server query time: ${data.responseJSON.query_time}`);
                        }
                    },
                    error: function (xhr, error, thrown) {
                        showError(`DataTables error: ${error} - ${thrown}`);
                        toggleLoading(false);
                        isTableInitializing = false;
                    }
                },
                columns: columnDefs,
                dom: 'rti', // Remove paging controls and buttons
                stateSave: true, // Save table state between loads
                searchDelay: 300, // Reduced delay for search
                language: {
                    processing: "Loading data, please wait..."
                },
                // Use optimized search settings
                search: {
                    caseInsensitive: true,
                    smart: true,
                    regex: false
                },

// Then enhance the initialization to be more robust with error handling
                initComplete: function () {
                    try {
                        // This ensures all initialization is complete
                        toggleLoading(false);
                        isTableInitializing = false;

                        // Lazy load visible rows for better performance
                        setTimeout(() => {
                            if (this.scroller) {
                                try {
                                    this.scroller.measure();
                                } catch (e) {
                                    console.warn("Error measuring scroller:", e);
                                }
                            }
                        }, 50);

                        // Initialize features in a controlled sequence with error handling
                        console.log("Initializing advanced search features...");

                        // Step 1: Set up keyboard navigation
                        try {
                            setupKeyboardNavigation();
                            console.log("Keyboard navigation initialized");
                        } catch (e) {
                            console.error("Error setting up keyboard navigation:", e);
                        }

                        // Step 2: Set up search history
                        try {
                            setupSearchHistory();
                            console.log("Search history initialized");
                        } catch (e) {
                            console.error("Error setting up search history:", e);
                        }

                        // Step 3: Set up advanced search (this should come last as it might depend on the others)
                        try {
                            setupAdvancedSearch();
                            console.log("Advanced search initialized");
                        } catch (e) {
                            console.error("Error setting up advanced search:", e);
                        }

                        console.log("All search features initialized successfully");
                    } catch (error) {
                        console.error("Error during table initialization:", error);
                        // Still make sure we turn off loading indicator even if there's an error
                        toggleLoading(false);
                        isTableInitializing = false;
                    }
                }
            });

            // Add search throttling for better performance
            const originalSearch = dataTable.search;
            let searchThrottleTimeout;

            dataTable.search = function (value, regex, smart, caseInsen) {
                clearTimeout(searchThrottleTimeout);

                // Skip if value is the same as current search
                if (value === dataTable.search()) return this;

                // Show loading indicator for longer searches
                if (value && value.length > 2) {
                    toggleLoading(true);

                    // Show progress bar
                    const progressBar = document.getElementById('search-progress');
                    progressBar.style.display = 'block';
                    progressBar.style.width = '0%';

                    // Animate progress
                    setTimeout(() => {
                        progressBar.style.width = '70%';
                    }, 50);
                }

                // Throttle search requests
                searchThrottleTimeout = setTimeout(() => {
                    originalSearch.call(dataTable, value, regex, smart, caseInsen).draw();

                    // When search completes, hide progress bar with animation
                    setTimeout(() => {
                        const progressBar = document.getElementById('search-progress');
                        progressBar.style.width = '100%';
                        setTimeout(() => {
                            progressBar.style.width = '0%';
                            progressBar.style.display = 'none';
                        }, 300);
                    }, 100);
                }, 350);

                return this;
            };

            // Attach event handlers
            attachEventHandlers();

            // Save column settings to localStorage
            localStorage.setItem('taitur_columns', JSON.stringify(tableColumns));

        } catch (error) {
            showError(`Error initializing table: ${error.message}`);
            console.error(error);
            toggleLoading(false);
            isTableInitializing = false;
        }
    }

    // Add a new function for keyboard navigation
    function setupKeyboardNavigation() {
        // Add keyboard shortcuts for table navigation
        document.addEventListener('keydown', function (e) {
            // Skip if in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Ctrl+F to focus search
            if ((e.ctrlKey && e.key === 'f') || e.key === '/') {
                e.preventDefault();
                document.getElementById('advanced-search-input').focus();
            }

            // Esc to clear search
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('advanced-search-input');
                if (searchInput.value) {
                    searchInput.value = '';
                    dataTable.search('').draw();
                    $('#data-table tbody td span.search-highlight').each(function () {
                        const parent = $(this).parent();
                        parent.text($(this).text());
                    });
                    disableNavButtons();
                }
            }

            // Handle search result navigation (F3, Shift+F3)
            if (searchResults && searchResults.length > 0) {
                // F3 or Ctrl+G for next result
                if (e.key === 'F3' || (e.ctrlKey && e.key === 'g')) {
                    e.preventDefault();
                    if (currentResultIndex < searchResults.length - 1) {
                        navigateToResult(currentResultIndex + 1);
                    } else {
                        // Wrap around to first result
                        navigateToResult(0);
                    }
                }

                // Shift+F3 or Ctrl+Shift+G for previous result
                if ((e.shiftKey && e.key === 'F3') || (e.ctrlKey && e.shiftKey && e.key === 'g')) {
                    e.preventDefault();
                    if (currentResultIndex > 0) {
                        navigateToResult(currentResultIndex - 1);
                    } else {
                        // Wrap around to last result
                        navigateToResult(searchResults.length - 1);
                    }
                }
            }
        });

        // Make table keyboard navigable
        const dataTable = document.getElementById('data-table');

        // Add focus styles to show when table is focused
        dataTable.addEventListener('focus', function () {
            this.classList.add('table-focus');
        });

        dataTable.addEventListener('blur', function () {
            this.classList.remove('table-focus');
        });
    }

    function setupSearchHistory() {
        const searchInput = document.getElementById('advanced-search-input');
        const suggestionsContainer = document.getElementById('search-suggestions');

        // Show history when input is focused
        searchInput.addEventListener('focus', function () {
            if (searchHistory.length > 0 && !searchInput.value) {
                showSearchHistory();
            }
        });

        // Hide suggestions when clicking elsewhere
        document.addEventListener('click', function (event) {
            if (!searchInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        // Show search history suggestions
        function showSearchHistory() {
            if (searchHistory.length === 0) return;

            suggestionsContainer.innerHTML = '';

            // Add recent searches header
            const header = document.createElement('div');
            header.className = 'p-2 text-muted small fw-bold border-bottom';
            header.textContent = 'Recent Searches';
            suggestionsContainer.appendChild(header);

            // Add search history items
            searchHistory.forEach(term => {
                const item = document.createElement('div');
                item.className = 'p-2 search-suggestion-item';

                // Parse and format the search query to show its components
                const parsedQuery = parseSearchQuery(term);

                // Create formatted display with different styling for different parts
                let displayHTML = '';

                // Column filters
                parsedQuery.columnFilters.forEach(filter => {
                    displayHTML += `<span class="search-tag column-tag">${filter.column}:${filter.value}</span>`;
                });

                // Exact phrases
                parsedQuery.exactPhrases.forEach(phrase => {
                    displayHTML += `<span class="search-tag phrase-tag">"${phrase}"</span>`;
                });

                // Exclude terms
                parsedQuery.excludeTerms.forEach(term => {
                    displayHTML += `<span class="search-tag exclude-tag">-${term}</span>`;
                });

                // Regular terms
                parsedQuery.terms.forEach(term => {
                    displayHTML += `<span class="search-tag">${term}</span>`;
                });

                // If empty after parsing, just show the raw term
                if (!displayHTML) {
                    displayHTML = `<span>${term}</span>`;
                }

                item.innerHTML = displayHTML;

                item.addEventListener('click', function () {
                    searchInput.value = term;
                    suggestionsContainer.style.display = 'none';
                    performSearch();
                });
                suggestionsContainer.appendChild(item);
            });

            // Add clear history option
            const clearHistoryItem = document.createElement('div');
            clearHistoryItem.className = 'p-2 search-suggestion-item text-muted border-top';
            clearHistoryItem.innerHTML = '<i class="bi bi-trash"></i> Clear search history';
            clearHistoryItem.addEventListener('click', function () {
                searchHistory = [];
                localStorage.removeItem('taitur_search_history');
                suggestionsContainer.style.display = 'none';
            });
            suggestionsContainer.appendChild(clearHistoryItem);

            suggestionsContainer.style.display = 'block';
        }
    }

    // Add search to history
    function addToSearchHistory(query) {
        if (!query || query.length < 2) return;

        // Remove if already exists
        const index = searchHistory.indexOf(query);
        if (index > -1) {
            searchHistory.splice(index, 1);
        }

        // Add to front of array
        searchHistory.unshift(query);

        // Limit to 10 entries
        if (searchHistory.length > 10) {
            searchHistory.pop();
        }

        // Save to localStorage
        try {
            localStorage.setItem('taitur_search_history', JSON.stringify(searchHistory));
        } catch (e) {
            console.error("Could not save search history", e);
        }
    }

    // Function to scroll to and highlight the current result
    function navigateToResult(index, animate = true) {
        if (index < 0 || index >= searchResults.length) return;

        // Remove active highlight from previous result
        $('.search-highlight.active').removeClass('active');

        currentResultIndex = index;
        const result = searchResults[index];

        // Scroll to the cell
        const cellSelector = `#data-table tbody tr:nth-child(${result.rowIndex + 1}) td:nth-child(${result.colIndex + 1})`;
        const cell = $(cellSelector);

        if (cell.length > 0) {
            // Find the highlight within the cell and make it active
            const highlight = cell.find('.search-highlight');
            highlight.addClass('active');

            // Scroll the row into view with a smooth effect that positions it in the middle
            if (animate) {
                // Using scrollIntoView with 'center' alignment
                cell[0].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                    inline: 'center'
                });

                // Add a brief flash animation to make it easier to find
                highlight.css('transition', 'background-color 0.3s');
                highlight.css('background-color', '#ffc107');
                setTimeout(() => {
                    highlight.css('background-color', '');
                }, 300);
            } else {
                cell[0].scrollIntoView({
                    block: 'center',
                    inline: 'center'
                });
            }
        }

        // Update navigation buttons and counter
        updateResultCountDisplay();
    }

    // Function to update navigation buttons and result count display
    function updateResultCountDisplay() {
        const searchCount = document.getElementById('search-count');
        const prevBtn = document.getElementById('prev-result');
        const nextBtn = document.getElementById('next-result');
        const searchInput = document.getElementById('advanced-search-input');

        if (searchResults.length > 0) {
            searchCount.textContent = `${currentResultIndex + 1}/${searchResults.length}`;
            prevBtn.disabled = false;
            nextBtn.disabled = false;

            // Add visual indicator for search state
            searchCount.classList.add('text-primary');
            searchInput.classList.add('border-primary');
        } else {
            searchCount.textContent = '0/0';
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            // Remove visual indicators
            searchCount.classList.remove('text-primary');
            searchInput.classList.remove('border-primary');
        }
    }

    function parseSearchQuery(query) {
        if (!query) return {terms: [], columnFilters: [], exactPhrases: [], excludeTerms: []};

        const result = {
            terms: [],
            columnFilters: [],
            exactPhrases: [],
            excludeTerms: []
        };

        // Regular expression for column:value pattern
        const colRegex = /(\w+):(([^\s"]+)|("([^"]*)"))/g;
        let match;

        // Extract column filters
        while ((match = colRegex.exec(query)) !== null) {
            const columnName = match[1];
            // Handle both quoted and unquoted values
            const value = match[5] || match[3]; // match[5] for quoted values, match[3] for unquoted

            result.columnFilters.push({column: columnName, value: value});
            // Remove from original query so we don't match it again
            query = query.replace(match[0], ' ');
        }

        // Extract exact phrases (in quotes)
        const phraseRegex = /"([^"]*)"/g;
        while ((match = phraseRegex.exec(query)) !== null) {
            if (match[1].trim()) {
                result.exactPhrases.push(match[1]);
                // Remove from original query
                query = query.replace(match[0], ' ');
            }
        }

        // Extract exclude terms (prefixed with -)
        const excludeRegex = /-(\w+)/g;
        while ((match = excludeRegex.exec(query)) !== null) {
            if (match[1].trim()) {
                result.excludeTerms.push(match[1]);
                // Remove from original query
                query = query.replace(match[0], ' ');
            }
        }

        // Remaining terms
        const remainingTerms = query.split(/\s+/).filter(term => term.trim());
        result.terms = remainingTerms;

        return result;
    }

    // Build search query from components
    function buildSearchQuery(components) {
        let query = '';

        // Add column filters
        if (components.columnFilters && components.columnFilters.length) {
            components.columnFilters.forEach(filter => {
                // Quote the value if it contains spaces
                const value = filter.value.includes(' ') ? `"${filter.value}"` : filter.value;
                query += `${filter.column}:${value} `;
            });
        }

        // Add exact phrases
        if (components.exactPhrases && components.exactPhrases.length) {
            components.exactPhrases.forEach(phrase => {
                query += `"${phrase}" `;
            });
        }

        // Add exclude terms
        if (components.excludeTerms && components.excludeTerms.length) {
            components.excludeTerms.forEach(term => {
                query += `-${term} `;
            });
        }

        // Add regular terms
        if (components.terms && components.terms.length) {
            components.terms.forEach(term => {
                query += `${term} `;
            });
        }

        return query.trim();
    }

    // Update search filter UI
    function updateSearchFilterUI() {
        // Populate column search options if empty
        const columnSearchOptions = document.getElementById('column-search-options');
        if (columnSearchOptions.children.length <= 1) {
            // Clear loading placeholder
            columnSearchOptions.innerHTML = '';

            // Add "All Columns" option at the top
            const allOption = document.createElement('div');
            allOption.className = 'column-search-item';
            allOption.innerHTML = `
            <input type="checkbox" class="form-check-input" id="search-column-all" data-column="all" checked>
            <label for="search-column-all" class="form-check-label">All Columns</label>
        `;
            columnSearchOptions.appendChild(allOption);

            // Add individual column options
            tableColumns.forEach(col => {
                const option = document.createElement('div');
                option.className = 'column-search-item';
                option.innerHTML = `
                <input type="checkbox" class="form-check-input search-column-option"
                       id="search-column-${col.name}" data-column="${col.name}" checked>
                <label for="search-column-${col.name}" class="form-check-label">${col.name}</label>
            `;
                columnSearchOptions.appendChild(option);
            });

            // Handle "All Columns" checkbox
            document.getElementById('search-column-all').addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll('.search-column-option').forEach(checkbox => {
                    checkbox.checked = checked;
                });
            });

            // Handle individual column checkboxes
            document.querySelectorAll('.search-column-option').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    // If any individual checkbox is unchecked, uncheck "All Columns" too
                    if (!this.checked) {
                        document.getElementById('search-column-all').checked = false;
                    }

                    // If all individual checkboxes are checked, check "All Columns" too
                    const allChecked = Array.from(document.querySelectorAll('.search-column-option'))
                        .every(cb => cb.checked);
                    if (allChecked) {
                        document.getElementById('search-column-all').checked = true;
                    }
                });
            });
        }

        // Handle apply button
        document.getElementById('apply-search-filters').addEventListener('click', function () {
            // Get selected columns
            const selectedColumns = Array.from(document.querySelectorAll('.search-column-option:checked'))
                .map(cb => cb.dataset.column);

            // Check if "All Columns" is selected
            const allColumnsSelected = document.getElementById('search-column-all').checked;

            // Parse current search query
            const searchInput = document.getElementById('advanced-search-input');
            const currentQuery = parseSearchQuery(searchInput.value);

            // Build a new query with selected column filters if not all columns selected
            if (!allColumnsSelected && selectedColumns.length > 0) {
                // Create a visual indicator that filters are active
                document.querySelector('.search-filter-btn').classList.add('has-active-filters');
            } else {
                document.querySelector('.search-filter-btn').classList.remove('has-active-filters');
            }

            // Close dropdown
            const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.search-filter-btn'));
            if (dropdown) dropdown.hide();

            // Perform the search
            performSearch();
        });

        // Handle clear filters button
        document.getElementById('clear-search-filters').addEventListener('click', function () {
            // Check all column options
            document.querySelectorAll('.search-column-option, #search-column-all').forEach(checkbox => {
                checkbox.checked = true;
            });

            // Remove filter indicator
            document.querySelector('.search-filter-btn').classList.remove('has-active-filters');

            // Close dropdown
            const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.search-filter-btn'));
            if (dropdown) dropdown.hide();

            // Perform search without column filters
            performSearch();
        });
    }

    // Advanced search with optimized implementation
    function setupAdvancedSearch() {
        const searchInput = document.getElementById('advanced-search-input');
        const searchBtn = document.getElementById('search-btn');
        const prevBtn = document.getElementById('prev-result');
        const nextBtn = document.getElementById('next-result');
        const searchCount = document.getElementById('search-count');

        // Initialize search filter UI
        updateSearchFilterUI();

        // Declare variables for search functionality
        let searchTimeout = null;
        let searchResults = [];
        let currentResultIndex = -1;
        let lastSearchQuery = '';
        let isSearching = false;
        let searchHistory = [];
        let activeFilters = [];

        // Function to update navigation buttons and result count display
        function updateResultCountDisplay() {
            if (searchResults.length > 0) {
                searchCount.textContent = `${currentResultIndex + 1}/${searchResults.length}`;
                prevBtn.disabled = false;
                nextBtn.disabled = false;

                // Add visual indicator for search state
                searchCount.classList.add('text-primary');
                searchInput.classList.add('border-primary');
            } else {
                searchCount.textContent = '0/0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;

                // Remove visual indicators
                searchCount.classList.remove('text-primary');
                searchInput.classList.remove('border-primary');
            }
        }

        // Function to scroll to and highlight the current result
        function navigateToResult(index, animate = true) {
            if (index < 0 || index >= searchResults.length) return;

            // Remove active highlight from previous result
            $('.search-highlight.active, .search-highlight-exact.active').removeClass('active');

            currentResultIndex = index;
            const result = searchResults[index];

            // Scroll to the cell
            const cellSelector = `#data-table tbody tr:nth-child(${result.rowIndex + 1}) td:nth-child(${result.colIndex + 1})`;
            const cell = $(cellSelector);

            if (cell.length > 0) {
                // Find the highlight within the cell and make it active
                const highlight = cell.find('.search-highlight, .search-highlight-exact').eq(result.matchIndex || 0);
                highlight.addClass('active');

                // Add row highlighting to make it easier to see the context
                const row = cell.closest('tr');
                row.addClass('highlight-row');
                setTimeout(() => row.removeClass('highlight-row'), 2000);

                // Scroll the row into view with a smooth effect that positions it in the middle
                if (animate) {
                    // Using scrollIntoView with 'center' alignment
                    cell[0].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });

                    // Add a brief flash animation to make it easier to find
                    highlight.css('transition', 'background-color 0.3s');
                    highlight.css('background-color', '#ffc107');
                    setTimeout(() => {
                        highlight.css('background-color', '');
                    }, 300);
                } else {
                    cell[0].scrollIntoView({
                        block: 'center',
                        inline: 'center'
                    });
                }
            }

            // Update navigation buttons and counter
            updateResultCountDisplay();
        }

        // Function to disable navigation buttons
        function disableNavButtons() {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            searchCount.textContent = '0/0';
            searchCount.classList.remove('text-primary');
            searchInput.classList.remove('border-primary');
        }

        // Improved client-side search on loaded data
        function clientSideSearch(query) {
            if (!query) return;

            console.time('Client-side search');

            // Parse the search query for advanced components
            const parsedQuery = parseSearchQuery(query);
            console.log("Parsed query:", parsedQuery);

            // Reset search results
            searchResults = [];
            currentResultIndex = -1;

            // First clear any existing highlights
            $('#data-table tbody td span.search-highlight, #data-table tbody td span.search-highlight-exact').each(function () {
                const parent = $(this).parent();
                parent.text($(this).text());
            });

            // Get all visible rows and cells
            const visibleRows = $('#data-table tbody tr:visible');

            // Get selected columns for filtering
            const selectedColumns = Array.from(document.querySelectorAll('.search-column-option:checked'))
                .map(cb => cb.dataset.column);
            const allColumnsSelected = document.getElementById('search-column-all')?.checked || true;

            // Process all rows
            visibleRows.each(function (rowIndex) {
                const row = $(this);

                // Process cells in this row
                row.find('td').each(function (colIndex) {
                    // Skip the actions column (last column)
                    if (colIndex >= visibleColumns.length) return;

                    const cell = $(this);
                    const cellText = cell.text();
                    const columnName = visibleColumns[colIndex].name;

                    // Skip cells with no text or with input elements (being edited)
                    if (!cellText || cell.find('input, select, textarea').length > 0) return;

                    // Skip if this column is not selected for searching
                    if (!allColumnsSelected && !selectedColumns.includes(columnName)) return;

                    // Check for column-specific filters
                    if (parsedQuery.columnFilters.length > 0) {
                        const columnFilters = parsedQuery.columnFilters.filter(f => f.column.toLowerCase() === columnName.toLowerCase());
                        if (columnFilters.length > 0) {
                            // This cell has column-specific filters
                            columnFilters.forEach(filter => {
                                const cellTextLower = cellText.toLowerCase();
                                const filterValueLower = filter.value.toLowerCase();

                                if (cellTextLower.includes(filterValueLower)) {
                                    searchResults.push({
                                        cell: cell,
                                        row: row,
                                        colIndex: colIndex,
                                        rowIndex: rowIndex,
                                        textIndex: cellTextLower.indexOf(filterValueLower),
                                        matchType: 'column',
                                        matchValue: filter.value
                                    });

                                    // Highlight with special class for column filters
                                    const highlightedText = highlightExactMatch(cellText, filter.value);
                                    cell.html(highlightedText);
                                }
                            });
                        }
                    }

                    // Check for exact phrases
                    if (parsedQuery.exactPhrases.length > 0) {
                        const cellTextLower = cellText.toLowerCase();

                        parsedQuery.exactPhrases.forEach((phrase, phraseIndex) => {
                            const phraseLower = phrase.toLowerCase();
                            if (cellTextLower.includes(phraseLower)) {
                                searchResults.push({
                                    cell: cell,
                                    row: row,
                                    colIndex: colIndex,
                                    rowIndex: rowIndex,
                                    textIndex: cellTextLower.indexOf(phraseLower),
                                    matchType: 'exact',
                                    matchValue: phrase,
                                    matchIndex: phraseIndex
                                });

                                // Highlight with special class for exact matches
                                const highlightedText = highlightExactMatch(cellText, phrase);
                                cell.html(highlightedText);
                            }
                        });
                    }

                    // Skip cells that match exclude terms
                    let shouldExclude = false;
                    if (parsedQuery.excludeTerms.length > 0) {
                        const cellTextLower = cellText.toLowerCase();
                        shouldExclude = parsedQuery.excludeTerms.some(term =>
                            cellTextLower.includes(term.toLowerCase())
                        );

                        if (shouldExclude) {
                            return; // Skip this cell
                        }
                    }

                    // Check for regular search terms
                    if (parsedQuery.terms.length > 0) {
                        const cellTextLower = cellText.toLowerCase();

                        parsedQuery.terms.forEach((term, termIndex) => {
                            const termLower = term.toLowerCase();
                            if (cellTextLower.includes(termLower)) {
                                searchResults.push({
                                    cell: cell,
                                    row: row,
                                    colIndex: colIndex,
                                    rowIndex: rowIndex,
                                    textIndex: cellTextLower.indexOf(termLower),
                                    matchType: 'term',
                                    matchValue: term,
                                    matchIndex: termIndex
                                });

                                // Regular highlight for simple terms
                                const highlightedText = highlightText(cellText, term);
                                cell.html(highlightedText);
                            }
                        });
                    }

                    // If no specific search components, check the entire original query
                    if (parsedQuery.terms.length === 0 &&
                        parsedQuery.columnFilters.length === 0 &&
                        parsedQuery.exactPhrases.length === 0 &&
                        parsedQuery.excludeTerms.length === 0) {

                        const cellTextLower = cellText.toLowerCase();
                        const queryLower = query.toLowerCase();

                        if (cellTextLower.includes(queryLower)) {
                            searchResults.push({
                                cell: cell,
                                row: row,
                                colIndex: colIndex,
                                rowIndex: rowIndex,
                                textIndex: cellTextLower.indexOf(queryLower),
                                matchType: 'simple',
                                matchValue: query
                            });

                            // Regular highlight for simple query
                            const highlightedText = highlightText(cellText, query);
                            cell.html(highlightedText);
                        }
                    }
                });
            });

            // Sort results by row, then by column, then by text index
            searchResults.sort((a, b) => {
                if (a.rowIndex !== b.rowIndex) return a.rowIndex - b.rowIndex;
                if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                return a.textIndex - b.textIndex;
            });

            // Remove duplicates (same cell, same match type and value)
            const uniqueResults = [];
            const seen = new Set();

            searchResults.forEach(result => {
                const key = `${result.rowIndex}:${result.colIndex}:${result.matchType}:${result.matchValue}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueResults.push(result);
                }
            });

            searchResults = uniqueResults;

            console.timeEnd('Client-side search');
            console.log(`Found ${searchResults.length} results for "${query}"`);

            // Update UI
            updateResultCountDisplay();

            // Navigate to first result if any found
            if (searchResults.length > 0) {
                navigateToResult(0);
            }

            // Add to search history
            addToSearchHistory(query);
        }

        // Helper function to highlight exact matches
        function highlightExactMatch(text, query) {
            if (!query) return text;

            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('(' + escapeRegExp(query) + ')', 'gi');
            return text.replace(regex, '<span class="search-highlight-exact">$1</span>');
        }

        // Helper function to highlight regular text
        function highlightText(text, query) {
            if (!query) return text;

            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('(' + escapeRegExp(query) + ')', 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Combined search - client-side search for visible data then server-side search if needed
        function performSearch() {
            const query = searchInput.value.trim();

            // Clear existing highlights
            $('#data-table tbody td span.search-highlight, #data-table tbody td span.search-highlight-exact').each(function () {
                const parent = $(this).parent();
                parent.text($(this).text());
            });

            // Reset search results and UI
            searchResults = [];
            currentResultIndex = -1;
            disableNavButtons();

            if (!query) {
                // Clear search if query is empty
                dataTable.search('').draw();
                // Reset filter indicator
                document.querySelector('.search-filter-btn').classList.remove('has-active-filters');
                return;
            }

            // Set searching flag
            isSearching = true;

            // First try client-side search on currently loaded data
            clientSideSearch(query);

            // If no results found or fewer than expected, do server-side search
            if (searchResults.length === 0) {
                toggleLoading(true);
                searchInput.classList.add('searching');

                // Show progress indicator
                const progressBar = document.getElementById('search-progress');
                progressBar.style.width = '0%';
                progressBar.style.display = 'block';

                // Animate progress
                setTimeout(() => {
                    progressBar.style.width = '70%';
                }, 50);

                // Apply the search to the DataTable (server-side)
                dataTable.search(query).draw();

                // Setup a listener for when data is reloaded
                dataTable.one('draw.dt', function () {
                    toggleLoading(false);
                    searchInput.classList.remove('searching');

                    // Complete progress indicator
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressBar.style.display = 'none';
                    }, 300);

                    // Perform client-side search again on new data
                    setTimeout(() => {
                        clientSideSearch(query);
                        isSearching = false;
                    }, 100);
                });
            } else {
                isSearching = false;
            }
        }

        // Add search to history
        function addToSearchHistory(query) {
            if (!query || query.length < 2) return;

            // Remove if already exists
            const index = searchHistory.indexOf(query);
            if (index > -1) {
                searchHistory.splice(index, 1);
            }

            // Add to front of array
            searchHistory.unshift(query);

            // Limit to 10 entries
            if (searchHistory.length > 10) {
                searchHistory.pop();
            }

            // Save to localStorage
            try {
                localStorage.setItem('taitur_search_history', JSON.stringify(searchHistory));
            } catch (e) {
                console.error("Could not save search history", e);
            }
        }

        // Load search history
        function loadSearchHistory() {
            try {
                const saved = localStorage.getItem('taitur_search_history');
                if (saved) {
                    searchHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Could not load search history", e);
                searchHistory = [];
            }
        }

        // Event handlers
        searchBtn.addEventListener('click', function () {
            performSearch();
        });

        searchInput.addEventListener('keydown', function (e) {
            // Enter to search
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }

            // Up/down arrows for result navigation when results exist
            if (searchResults.length > 0) {
                if (e.key === 'ArrowDown' && !e.ctrlKey) {
                    e.preventDefault();
                    if (currentResultIndex < searchResults.length - 1) {
                        navigateToResult(currentResultIndex + 1);
                    } else {
                        // Wrap around to first result
                        navigateToResult(0);
                    }
                } else if (e.key === 'ArrowUp' && !e.ctrlKey) {
                    e.preventDefault();
                    if (currentResultIndex > 0) {
                        navigateToResult(currentResultIndex - 1);
                    } else {
                        // Wrap around to last result
                        navigateToResult(searchResults.length - 1);
                    }
                }
            }
        });

        // Debounced input handler for incremental search
        searchInput.addEventListener('input', function () {
            const query = searchInput.value.trim();

            // Immediately clear search if query is empty
            if (!query) {
                $('#data-table tbody td span.search-highlight, #data-table tbody td span.search-highlight-exact').each(function () {
                    const parent = $(this).parent();
                    parent.text($(this).text());
                });
                disableNavButtons();
                dataTable.search('').draw();
                document.querySelector('.search-filter-btn').classList.remove('has-active-filters');
                return;
            }

            // Debounce search to avoid too many queries
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            searchTimeout = setTimeout(() => {
                if (query.length >= 2 && query !== lastSearchQuery) {
                    lastSearchQuery = query;
                    performSearch();
                }
            }, 300);
        });

        // Navigation buttons
        nextBtn.addEventListener('click', function () {
            if (currentResultIndex < searchResults.length - 1) {
                navigateToResult(currentResultIndex + 1);
            } else {
                // Wrap around to first result
                navigateToResult(0);
            }
        });

        prevBtn.addEventListener('click', function () {
            if (currentResultIndex > 0) {
                navigateToResult(currentResultIndex - 1);
            } else {
                // Wrap around to last result
                navigateToResult(searchResults.length - 1);
            }
        });

        // Load search history on init
        loadSearchHistory();
    }

    // Attach event handlers for edit/save/cancel buttons and other interactions
    function attachEventHandlers() {
        // Row editing functionality
        $('#data-table tbody').on('click', '.edit-btn', function () {
            const row = dataTable.row($(this).closest('tr'));
            const rowData = row.data();
            const rowNode = row.node();

            // Mark row as being edited
            $(rowNode).addClass('editing');

            // Replace cell contents with input fields
            $(rowNode).find('td').each(function (cellIndex) {
                // Skip actions column (last column)
                if (cellIndex >= visibleColumns.length) return;

                const columnName = visibleColumns[cellIndex].name;
                const columnType = visibleColumns[cellIndex].type;
                const cellValue = rowData[columnName] || '';

                const originalContent = $(this).html();
                $(this).data('original', originalContent);

                // Create appropriate input based on column type
                let inputField;
                switch (columnType) {
                    case 'boolean':
                        inputField = `<select class="form-control form-control-sm edit-field"
                                  data-column="${columnName}">
                                  <option value="true" ${cellValue ? 'selected' : ''}>Yes</option>
                                  <option value="false" ${!cellValue ? 'selected' : ''}>No</option>
                                  </select>`;
                        break;
                    case 'date':
                    case 'datetime':
                        inputField = `<input type="date" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
                        break;
                    case 'number':
                    case 'integer':
                        inputField = `<input type="number" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
                        break;
                    case 'text':
                        if (cellValue && cellValue.length > 50) {
                            inputField = `<textarea class="form-control form-control-sm edit-field"
                                    data-column="${columnName}" rows="3">${cellValue}</textarea>`;
                        } else {
                            inputField = `<input type="text" class="form-control form-control-sm edit-field"
                                    value="${cellValue}" data-column="${columnName}">`;
                        }
                        break;
                    default:
                        inputField = `<input type="text" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
                }

                $(this).html(inputField);
            });
        });

        // Cancel editing
        $('#data-table tbody').on('click', '.cancel-btn', function () {
            const row = dataTable.row($(this).closest('tr'));
            const rowNode = row.node();

            // Restore original cell contents
            $(rowNode).find('td').each(function () {
                const originalContent = $(this).data('original');
                if (originalContent) {
                    $(this).html(originalContent);
                }
            });

            // Remove editing class
            $(rowNode).removeClass('editing');
        });

        // Save edited row
        $('#data-table tbody').on('click', '.save-btn', function () {
            toggleLoading(true);

            const row = dataTable.row($(this).closest('tr'));
            const rowData = row.data();
            const rowNode = row.node();

            // Find primary key column and value (assuming 'id' for now)
            const rowId = rowData['id'];

            // Collect updated values
            const updatedData = {...rowData};
            $(rowNode).find('.edit-field').each(function () {
                const columnName = $(this).data('column');
                let value = $(this).val();

                // Convert value based on column type
                const columnDef = tableColumns.find(col => col.name === columnName);
                if (columnDef) {
                    switch (columnDef.type) {
                        case 'boolean':
                            value = value === 'true';
                            break;
                        case 'number':
                            value = parseFloat(value);
                            break;
                        case 'integer':
                            value = parseInt(value, 10);
                            break;
                    }
                }

                updatedData[columnName] = value;
            });

            // Send update to server
            fetch(`/api/table/{{ table_name }}/rows/${rowId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    toggleLoading(false);

                    if (result.success) {
                        // Update row data in DataTable
                        row.data(updatedData).draw(false);
                        $(rowNode).removeClass('editing');

                        // Highlight updated cells
                        $(rowNode).find('td').each(function (cellIndex) {
                            if (cellIndex === visibleColumns.length) return;

                            $(this).addClass('edited');
                            setTimeout(() => {
                                $(this).removeClass('edited');
                            }, 3000);
                        });
                    } else {
                        showError('Error updating row: ' + result.message);
                    }
                })
                .catch(error => {
                    toggleLoading(false);
                    showError(`Error updating row: ${error.message}`);
                });
        });

        // Column settings button
        document.getElementById('column-settings-menu').addEventListener('click', openColumnSettings);

        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', () => {
            toggleLoading(true);
            dataTable.ajax.reload(() => {
                toggleLoading(false);
            });
        });

        // Export button
        document.getElementById('export-btn').addEventListener('click', function () {
            // Show export modal
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            exportModal.show();
        });

        // Export options
        document.getElementById('export-csv').addEventListener('click', function () {
            exportData('csv');
        });

        document.getElementById('export-excel').addEventListener('click', function () {
            exportData('excel');
        });

        document.getElementById('export-json').addEventListener('click', function () {
            exportData('json');
        });

        // View options
        document.querySelectorAll('.view-option').forEach(option => {
            option.addEventListener('click', function (e) {
                e.preventDefault();
                toggleLoading(true);
                const viewType = this.dataset.view;

                switch (viewType) {
                    case 'all':
                        // Show all columns
                        tableColumns.forEach(col => col.visible = true);
                        break;
                    case 'main':
                        // Show only main columns
                        tableColumns.forEach(col => {
                            col.visible = MAIN_COLUMNS.includes(col.name);
                        });
                        break;
                    case 'minimal':
                        // Show minimal set of columns
                        tableColumns.forEach(col => {
                            col.visible = MINIMAL_COLUMNS.includes(col.name);
                        });
                        break;
                }

                // Update visible columns and reinitialize
                visibleColumns = tableColumns.filter(col => col.visible);
                initializeTable();
            });
        });

        // Column links (quick navigation)
        document.querySelectorAll('.column-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const columnName = this.dataset.column;

                // Find the column
                const column = tableColumns.find(col => col.name === columnName);
                if (!column) return;

                // Make it visible if it's not already
                if (!column.visible) {
                    toggleLoading(true);
                    column.visible = true;
                    visibleColumns = tableColumns.filter(col => col.visible);
                    initializeTable();
                    return;
                }

                // Focus/highlight the column
                const colIndex = visibleColumns.findIndex(col => col.name === columnName);
                if (colIndex >= 0) {
                    // Scroll to make column visible
                    const headerCell = document.querySelector(`#data-table thead th:nth-child(${colIndex + 1})`);
                    if (headerCell) {
                        headerCell.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});

                        // Highlight the column temporarily
                        const cells = document.querySelectorAll(`#data-table td:nth-child(${colIndex + 1}), #data-table th:nth-child(${colIndex + 1})`);
                        cells.forEach(cell => {
                            cell.style.backgroundColor = '#fff3cd';
                            setTimeout(() => {
                                cell.style.backgroundColor = '';
                            }, 2000);
                        });
                    }
                }
            });
        });

        // Save view button
        document.getElementById('save-current-view').addEventListener('click', function (e) {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('saveViewModal'));
            modal.show();
        });

        // Confirm save view
        document.getElementById('confirm-save-view').addEventListener('click', function () {
            const viewName = document.getElementById('view-name').value.trim();
            if (!viewName) return;

            // Save current visible columns as a view
            const savedViews = JSON.parse(localStorage.getItem('taitur_saved_views') || '{}');
            savedViews[viewName] = visibleColumns.map(col => col.name);
            localStorage.setItem('taitur_saved_views', JSON.stringify(savedViews));

            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('saveViewModal'));
            modal.hide();

            // Show a success message
            alert(`View "${viewName}" has been saved.`);
        });
    }

    // Export data function
    function exportData(format) {
        // Hide export modal
        const exportModal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
        if (exportModal) exportModal.hide();

        toggleLoading(true);

        try {
            // Get current visible data (respecting search and sort)
            const visibleData = [];
            dataTable.rows({search: 'applied'}).every(function () {
                visibleData.push(this.data());
            });

            // Format data for export (only visible columns)
            const exportData = visibleData.map(row => {
                const filteredRow = {};
                visibleColumns.forEach(col => {
                    filteredRow[col.name] = row[col.name];
                });
                return filteredRow;
            });

            if (exportData.length === 0) {
                showError('No data to export. Try changing your search criteria.');
                toggleLoading(false);
                return;
            }

            let content, filename, type;

            switch (format) {
                case 'csv':
                    // Create CSV content
                    const header = visibleColumns.map(col => `"${col.name}"`).join(',');
                    const rows = exportData.map(row => {
                        return visibleColumns.map(col => {
                            const value = row[col.name];
                            if (value === null || value === undefined) return '""';
                            if (typeof value === 'string') return `"${value.replace(/"/g, '""')}"`;
                            return `"${value}"`;
                        }).join(',');
                    }).join('\n');

                    content = header + '\n' + rows;
                    filename = `${table_name}_data_${new Date().toISOString().slice(0, 10)}.csv`;
                    type = 'text/csv';
                    break;

                case 'json':
                    content = JSON.stringify(exportData, null, 2);
                    filename = `${table_name}_data_${new Date().toISOString().slice(0, 10)}.json`;
                    type = 'application/json';
                    break;

                case 'excel':
                    // For Excel we'll use a trick with HTML tables
                    const table = document.createElement('table');

                    // Add header row
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    visibleColumns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col.name;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    // Add data rows
                    const tbody = document.createElement('tbody');
                    exportData.forEach(rowData => {
                        const tr = document.createElement('tr');
                        visibleColumns.forEach(col => {
                            const td = document.createElement('td');
                            td.textContent = rowData[col.name] !== null && rowData[col.name] !== undefined ?
                                rowData[col.name] : '';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    // Create HTML with MSO styles for Excel
                    content = `
                        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
                        <head>
                            <!--[if gte mso 9]>
                            <xml>
                                <x:ExcelWorkbook>
                                    <x:ExcelWorksheets>
                                        <x:ExcelWorksheet>
                                            <x:Name>${table_name} Data</x:Name>
                                            <x:WorksheetOptions>
                                                <x:DisplayGridlines/>
                                            </x:WorksheetOptions>
                                        </x:ExcelWorksheet>
                                    </x:ExcelWorksheets>
                                </x:ExcelWorkbook>
                            </xml>
                            <![endif]-->
                            <style>
                                table, th, td {
                                    border: 1px solid black;
                                    border-collapse: collapse;
                                    padding: 5px;
                                }
                                th {
                                    background-color: #f2f2f2;
                                    font-weight: bold;
                                }
                            </style>
                        </head>
                        <body>
                            ${table.outerHTML}
                        </body>
                        </html>
                    `;
                    filename = `${table_name}_data_${new Date().toISOString().slice(0, 10)}.xls`;
                    type = 'application/vnd.ms-excel';
                    break;

                default:
                    showError(`Unsupported export format: ${format}`);
                    toggleLoading(false);
                    return;
            }

            // Create download link
            const blob = new Blob([content], {type: type});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            document.body.appendChild(link);
            link.click();

            // Clean up
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            toggleLoading(false);

        } catch (error) {
            console.error('Export error:', error);
            showError(`Error exporting data: ${error.message}`);
            toggleLoading(false);
        }
    }

    // Column settings modal
    function openColumnSettings() {
        const settingsBody = document.getElementById('column-settings-body');
        settingsBody.innerHTML = '';

        // Add filter functionality
        document.getElementById('column-filter').addEventListener('keyup', function () {
            const filterValue = this.value.toLowerCase();
            document.querySelectorAll('#column-settings-table tbody tr').forEach(row => {
                const columnName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                if (columnName.includes(filterValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Add all columns to settings
        tableColumns.forEach((column, index) => {
            const row = document.createElement('tr');

            // Visible checkbox
            const visibleCell = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input column-visible';
            checkbox.dataset.column = column.name;
            checkbox.checked = column.visible;
            visibleCell.appendChild(checkbox);

            // Column name
            const nameCell = document.createElement('td');
            nameCell.textContent = column.name;

            // Type
            const typeCell = document.createElement('td');
            typeCell.textContent = column.type;

            // Order
            const orderCell = document.createElement('td');
            const orderInput = document.createElement('input');
            orderInput.type = 'number';
            orderInput.className = 'form-control form-control-sm column-order';
            orderInput.dataset.column = column.name;
            orderInput.value = index;
            orderInput.min = 0;
            orderCell.appendChild(orderInput);

            row.appendChild(visibleCell);
            row.appendChild(nameCell);
            row.appendChild(typeCell);
            row.appendChild(orderCell);

            settingsBody.appendChild(row);
        });

        // Reset column filter
        document.getElementById('column-filter').value = '';
        document.querySelectorAll('#column-settings-table tbody tr').forEach(row => {
            row.style.display = '';
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('columnSettingsModal'));
        modal.show();

        // Save settings button
        document.getElementById('save-column-settings').addEventListener('click', saveColumnSettings);
    }

    function saveColumnSettings() {
        toggleLoading(true);

        // Update column visibility and order
        const visibilityCheckboxes = document.querySelectorAll('.column-visible');
        const orderInputs = document.querySelectorAll('.column-order');

        // Update tableColumns array with new settings
        visibilityCheckboxes.forEach(checkbox => {
            const columnName = checkbox.dataset.column;
            const column = tableColumns.find(col => col.name === columnName);
            if (column) {
                column.visible = checkbox.checked;
            }
        });

        // Create array of {name, order} objects
        const columnOrders = Array.from(orderInputs).map(input => ({
            name: input.dataset.column,
            order: parseInt(input.value, 10)
        }));

        // Sort by order
        columnOrders.sort((a, b) => a.order - b.order);

        // Reorder tableColumns array
        const orderedColumns = [];
        columnOrders.forEach(item => {
            const column = tableColumns.find(col => col.name === item.name);
            if (column) {
                orderedColumns.push(column);
            }
        });

        // Update tableColumns with new order
        tableColumns = orderedColumns;

        // Update visible columns
        visibleColumns = tableColumns.filter(col => col.visible);

        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal'));
        modal.hide();

        // Reinitialize table with new column settings
        initializeTable();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Apply full screen layout
        document.body.classList.add('overflow-hidden');

        // Initialize the table
        initializeWithFirstRow();

        // Add window resize handler for better responsive behavior
        window.addEventListener('resize', function () {
            if (dataTable) {
                dataTable.columns.adjust();
                if (dataTable.scroller) {
                    dataTable.scroller.measure();
                }
            }
        });
    });
</script>
{% endblock %}