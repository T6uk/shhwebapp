<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suur Andmetabel</title>

    <!-- Inter font - modern, clean typography -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    'sans': ['Inter', 'system-ui', 'sans-serif'],
                },
                extend: {
                    colors: {
                        'primary': '#0072CE',
                        'primary-dark': '#005ba3',
                        'primary-light': '#e6f0f9',
                    }
                }
            }
        }
    </script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- AG Grid CSS and JS (replacing Tabulator) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-theme-alpine.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.js"></script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PWA support -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0072CE">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 100%;
        }

        /* AG Grid customizations to match your theme */
        .ag-theme-alpine {
            --ag-foreground-color: #1f2937;
            --ag-background-color: white;
            --ag-header-background-color: #f3f4f6;
            --ag-odd-row-background-color: #f9fafb;
            --ag-row-hover-color: #e6f0f9;
            --ag-border-color: #e5e7eb;
            --ag-font-family: 'Inter', sans-serif;
            --ag-font-size: 14px;
            --ag-header-column-separator-display: block;
            --ag-header-column-separator-height: 100%;
            --ag-header-column-separator-width: 1px;
            --ag-header-column-separator-color: #e5e7eb;
        }

        /* Dark mode support */
        .dark-mode .ag-theme-alpine {
            --ag-foreground-color: #e5e7eb;
            --ag-background-color: #1f2937;
            --ag-header-background-color: #111827;
            --ag-odd-row-background-color: #374151;
            --ag-row-hover-color: #4B5563;
            --ag-border-color: #4B5563;
        }

        /* Add fixed height to ensure grid fills available space */
        #data-table {
            height: 100%;
            width: 100%;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 100%;
        }

        #table-container {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            margin-top: 0.75rem;
        }

        /* Modern card styling */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: visible; /* Changed from hidden to allow dropdowns to be visible */
            transition: box-shadow 0.2s ease;
            border: 1px solid #f0f0f0;
            position: relative; /* Added to ensure proper context for dropdown positioning */
        }

        /* Buttons and form elements */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-icon {
            width: 2.5rem;
            padding: 0.5rem;
        }

        .btn-primary {
            background-color: #0072CE;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 114, 206, 0.2);
        }

        .btn-primary:hover {
            background-color: #005ba3;
            transform: translateY(-1px);
            box-shadow: 0 3px 7px rgba(0, 114, 206, 0.25);
        }

        .btn-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .input-control {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            width: 100%;
            background-color: white;
        }

        .input-control:focus {
            outline: none;
            border-color: #0072CE;
            box-shadow: 0 0 0 3px rgba(0, 114, 206, 0.1);
        }

        .input-group {
            display: flex;
            position: relative;
        }

        .input-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0.75rem;
            color: #9ca3af;
            pointer-events: none;
        }

        .input-icon ~ .input-control {
            padding-left: 2.5rem;
        }

        /* Top app bar */
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
        }

        .app-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: #1f2937;
            line-height: 1.2;
            background-image: linear-gradient(90deg, #0072CE, #0090FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
        }

        /* Toolbar styling */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: space-between;
        }

        .toolbar-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }

        .search-bar {
            flex-grow: 1;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Dropdowns */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            z-index: 100; /* Increased z-index for better stacking */
            min-width: 250px;
            max-width: calc(100vw - 2rem); /* Prevent overflow on small screens */
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 0.75rem;
            margin-top: 0.25rem;
            display: none;
            overflow: visible;
            border: 1px solid #f0f0f0;
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-section {
            margin-bottom: 0.75rem;
        }

        .dropdown-section-title {
            font-weight: 500;
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .dropdown-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .dropdown-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background-color: #f3f4f6;
            color: #374151;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .dropdown-button:hover {
            background-color: #0072CE;
            color: white;
        }

        .dropdown-button i {
            margin-right: 0.375rem;
            font-size: 0.875rem;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            color: #374151;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            cursor: pointer;
            border-radius: 0.375rem;
        }

        .dropdown-item:hover {
            background-color: #f9fafb;
            color: #0072CE;
        }

        .dropdown-item i {
            color: #6b7280;
            width: 1.25rem;
            text-align: center;
            font-size: 0.875rem;
        }

        .dropdown-divider {
            height: 1px;
            margin: 0.5rem 0;
            background-color: #f0f0f0;
        }

        /* Quick links now in a dropdown */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f3f4f6;
            color: #374151;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .quick-link:hover {
            background-color: #0072CE;
            color: white;
        }

        /* Loading */
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            transition: all 0.2s ease;
        }

        .loading-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #f0f0f0;
        }

        .spinner {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 3px solid #e5e7eb;
            border-top-color: #0072CE;
            animation: spin 0.8s linear infinite;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #f3f4f6;
            color: #6b7280;
            height: 1.75rem;
        }

        /* Filter panel */
        .filter-panel {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .filter-panel.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group-title {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .filter-select {
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            background-color: white;
            min-width: 10rem;
        }

        .filter-input {
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            background-color: white;
            flex: 1;
        }

        .filter-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            width: 2rem;
            border-radius: 0.375rem;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.15s ease;
        }

        .filter-add-btn:hover {
            background-color: #d1d5db;
            color: #1f2937;
        }

        .filter-remove-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            width: 2rem;
            border-radius: 0.375rem;
            background-color: #fee2e2;
            color: #ef4444;
            transition: all 0.15s ease;
        }

        .filter-remove-btn:hover {
            background-color: #fecaca;
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Column visibility modal */
        #column-modal {
            z-index: 200; /* Higher than dropdowns */
        }

        #column-modal .bg-white {
            max-height: 90vh;
            overflow-y: auto;
            max-width: 95vw;
        }

        #column-checkboxes {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-5px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-section {
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .toolbar-section .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            .search-bar {
                max-width: none;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .app-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .dropdown-menu {
                left: 0;
                right: 0;
                width: auto;
                position: fixed; /* On mobile, position relative to viewport */
                margin: 0 0.5rem;
            }

            .quick-links-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-select, .filter-input {
                width: 100%;
                min-width: 0;
            }

            .filter-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .filter-actions .btn {
                flex: 1 0 auto;
                min-width: 0;
                padding: 0.375rem 0.5rem;
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .btn {
                padding: 0.375rem 0.75rem;
            }
        }

        /* Small screens */
        @media (max-width: 480px) {
            .toolbar-section {
                gap: 0.25rem;
            }

            .toolbar-section .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.75rem;
            }

            .status-chip {
                font-size: 0.625rem;
                padding: 0.125rem 0.5rem;
                height: 1.5rem;
            }

            .quick-links-grid {
                grid-template-columns: 1fr;
            }

            #column-checkboxes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-2 py-2">
        <!-- App Bar -->
        <div class="app-bar">
        </div>

        <!-- Main Toolbar -->
        <div class="card p-3 mb-2">
            <div class="toolbar">
                <!-- Left section: search and main actions -->
                <div class="toolbar-section">
                    <!-- Search bar -->
                    <div class="search-bar">
                        <div class="input-group flex-1">
                            <i class="input-icon fas fa-search"></i>
                            <input type="text" id="search-input" class="input-control" placeholder="Otsi...">
                        </div>
                        <button id="search-button" class="btn btn-primary">
                            <span class="hidden sm:inline">Otsi</span>
                            <i class="fas fa-search sm:hidden"></i>
                        </button>
                        <button id="reset-button" class="btn btn-secondary">
                            <span class="hidden sm:inline">Lähtesta</span>
                            <i class="fas fa-times sm:hidden"></i>
                        </button>
                    </div>

                    <!-- Quick Links Dropdown -->
                    <div class="dropdown">
                        <button id="links-dropdown-toggle" class="btn btn-secondary">
                            <i class="fas fa-link mr-1.5"></i>
                            <span class="hidden sm:inline">Kiirlingid</span>
                        </button>
                        <div id="links-dropdown-menu" class="dropdown-menu">
                            <div class="dropdown-title">Veergude kiirlingid</div>
                            <div class="quick-links-grid" id="column-quick-links">
                                <!-- Quick links will be inserted here dynamically -->
                                <div class="text-gray-400 text-xs italic p-2">Veergude laadimine...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter button -->
                    <button id="filter-toggle" class="btn btn-secondary">
                        <i class="fas fa-filter mr-1.5"></i>
                        <span class="hidden sm:inline">Filter</span>
                    </button>
                </div>

                <!-- Right section: tools and utilities -->
                <div class="toolbar-section">
                    <!-- Status chip -->
                    <div id="status" class="status-chip"></div>

                    <!-- Tools dropdown (Updated) -->
                    <div class="dropdown">
                        <button id="tools-dropdown-toggle" class="btn btn-secondary">
                            <i class="fas fa-tools mr-1.5"></i>
                            <span class="hidden sm:inline">Tööriistad</span>
                        </button>
                        <div id="tools-dropdown-menu" class="dropdown-menu">
                            <div class="dropdown-title">Tööriistad</div>

                            <!-- New tool buttons -->
                            <div class="dropdown-item" id="view-file">
                                <i class="fas fa-folder-open"></i>
                                <span>Vaata toimikut</span>
                            </div>
                            <div class="dropdown-item" id="virtual-file">
                                <i class="fas fa-folder"></i>
                                <span>Virtuaaltoimik</span>
                            </div>
                            <div class="dropdown-item" id="receipts-report">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <span>Laekumiste aruanne</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings dropdown (New) -->
                    <div class="dropdown">
                        <button id="settings-dropdown-toggle" class="btn btn-secondary">
                            <i class="fas fa-cog mr-1.5"></i>
                            <span class="hidden sm:inline">Seaded</span>
                        </button>
                        <div id="settings-dropdown-menu" class="dropdown-menu">
                            <div class="dropdown-title">Tabeli seaded</div>

                            <div class="dropdown-item" id="toggle-columns">
                                <i class="fas fa-eye"></i>
                                <span>Näita/peida veerud</span>
                            </div>
                            <div class="dropdown-item" id="save-column-layout">
                                <i class="fas fa-columns"></i>
                                <span>Salvesta veergude paigutus</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="font-increase">
                                <i class="fas fa-text-height"></i>
                                <span>Suurenda teksti</span>
                            </div>
                            <div class="dropdown-item" id="font-decrease">
                                <i class="fas fa-text-height fa-flip-vertical"></i>
                                <span>Vähenda teksti</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="toggle-dark-mode">
                                <i class="fas fa-moon"></i>
                                <span>Tume režiim</span>
                            </div>
                        </div>
                    </div>

                    <!-- Widgets dropdown -->
                    <div class="dropdown">
                        <button id="widgets-dropdown-toggle" class="btn btn-secondary">
                            <i class="fas fa-puzzle-piece mr-1.5"></i>
                            <span class="hidden sm:inline">Vidinad</span>
                        </button>
                        <div id="widgets-dropdown-menu" class="dropdown-menu">
                            <div class="dropdown-title">Vidinad</div>

                            <!-- Widgets menu items -->
                            <div class="dropdown-item" id="save-view">
                                <i class="fas fa-save"></i>
                                <span>Salvesta vaade</span>
                            </div>
                            <div class="dropdown-item" id="load-view">
                                <i class="fas fa-folder-open"></i>
                                <span>Lae vaade</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="toggle-compact">
                                <i class="fas fa-compress"></i>
                                <span>Kompaktne režiim</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div id="filter-panel" class="filter-panel">
            <div class="filter-group-title">Kohandatud filtrid</div>

            <div id="filter-container">
                <!-- Initial filter row -->
                <div class="filter-row" data-id="1">
                    <select class="filter-select filter-field">
                        <option value="">Vali veerg...</option>
                        <!-- Column options will be added dynamically -->
                    </select>

                    <select class="filter-select filter-operator">
                        <option value="contains">Sisaldab</option>
                        <option value="equals">Võrdub</option>
                        <option value="starts">Algab</option>
                        <option value="ends">Lõpeb</option>
                        <option value="greater">Suurem kui</option>
                        <option value="less">Väiksem kui</option>
                    </select>

                    <input type="text" class="filter-input" placeholder="Filtri väärtus">

                    <button class="filter-remove-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Add filter button -->
            <div class="mt-3 mb-2">
                <button id="add-filter-row" class="btn btn-secondary">
                    <i class="fas fa-plus mr-1.5"></i>
                    <span>Lisa filtritingimus</span>
                </button>
            </div>

            <!-- Filter actions -->
            <div class="filter-actions">
                <button id="apply-filters" class="btn btn-primary">
                    <i class="fas fa-check mr-1.5"></i>
                    <span>Rakenda filtrid</span>
                </button>
                <button id="clear-filters" class="btn btn-secondary">
                    <i class="fas fa-times mr-1.5"></i>
                    <span>Tühista filtrid</span>
                </button>
                <button id="save-filter" class="btn btn-secondary">
                    <i class="fas fa-save mr-1.5"></i>
                    <span>Salvesta filter</span>
                </button>
            </div>
        </div>

        <!-- Table Container with AG Grid -->
        <div id="table-container" class="card">
            <div id="data-table" class="ag-theme-alpine"></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center z-50">
            <div class="loading-card">
                <div class="spinner mb-4"></div>
                <p class="text-text font-medium">Laadimine...</p>
            </div>
        </div>

        <!-- Column Visibility Modal (hidden by default) -->
        <div id="column-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="absolute inset-0 bg-black bg-opacity-40" id="column-modal-backdrop"></div>
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg z-10 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Veergude nähtavus</h3>
                    <button id="close-column-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="max-h-80 overflow-y-auto mb-4">
                    <div id="column-checkboxes" class="grid grid-cols-2 gap-2">
                        <!-- Column checkboxes will be added here dynamically -->
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button id="apply-column-changes" class="btn btn-primary">
                        <span>Rakenda</span>
                    </button>
                    <button id="cancel-column-changes" class="btn btn-secondary">
                        <span>Tühista</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let gridApi = null;
        let columnDefs = [];
        let searchTerm = '';
        let currentFontSize = 14;
        let isDarkMode = false;
        let isCompactMode = false;
        let activeFilters = [];
        let nextFilterId = 2; // Start at 2 since we have one filter row by default
        let columnVisibility = {}; // To track which columns are visible

        // Initialize when document is ready
        $(document).ready(function() {
            // Set the initial table container height
            resizeTableContainer();

            // Handle window resize
            $(window).resize(function() {
                resizeTableContainer();
                if (gridApi) {
                    gridApi.sizeColumnsToFit();
                }
            });

            // Get columns first
            getColumns();

            // Set up dropdown toggles
            setupDropdowns();

            // Set up event handlers
            setupEventHandlers();
        });

        // Set up dropdown toggles
        function setupDropdowns() {
            // Toggle tools dropdown
            $("#tools-dropdown-toggle").click(function(e) {
                e.stopPropagation();
                $("#tools-dropdown-menu").toggleClass("show");
                $("#widgets-dropdown-menu, #links-dropdown-menu, #settings-dropdown-menu").removeClass("show");
            });

            // Toggle widgets dropdown
            $("#widgets-dropdown-toggle").click(function(e) {
                e.stopPropagation();
                $("#widgets-dropdown-menu").toggleClass("show");
                $("#tools-dropdown-menu, #links-dropdown-menu, #settings-dropdown-menu").removeClass("show");
            });

            // Toggle settings dropdown
            $("#settings-dropdown-toggle").click(function(e) {
                e.stopPropagation();
                $("#settings-dropdown-menu").toggleClass("show");
                $("#tools-dropdown-menu, #links-dropdown-menu, #widgets-dropdown-menu").removeClass("show");
            });

            // Toggle quick links dropdown
            $("#links-dropdown-toggle").click(function(e) {
                e.stopPropagation();
                $("#links-dropdown-menu").toggleClass("show");
                $("#tools-dropdown-menu, #widgets-dropdown-menu, #settings-dropdown-menu").removeClass("show");
            });

            // Close dropdowns when clicking outside
            $(document).click(function() {
                $(".dropdown-menu").removeClass("show");
            });

            // Prevent dropdown closing when clicking inside dropdown
            $(".dropdown-menu").click(function(e) {
                e.stopPropagation();
            });
        }

        // Function to resize the table container
        function resizeTableContainer() {
            const windowHeight = $(window).height();
            const headerHeight = $(".app-bar").outerHeight(true);
            const toolbarHeight = $(".toolbar").parent().outerHeight(true);
            const filterPanelHeight = $("#filter-panel").hasClass("show") ? $("#filter-panel").outerHeight(true) : 0;
            const padding = 40; // Allow for some padding

            const tableHeight = windowHeight - headerHeight - toolbarHeight - filterPanelHeight - padding;
            $("#table-container").css("height", tableHeight + "px");
        }

        // Get columns from the API
        function getColumns() {
            $("#loading-overlay").show();
            $("#status").text("Laadimine...");

            $.ajax({
                url: "/api/v1/table/columns",
                method: "GET",
                dataType: "json",
                success: function(response) {
                    if (response && response.columns && response.columns.length > 0) {
                        // Process column data for AG Grid
                        columnDefs = response.columns.map(function(col) {
                            // Initialize as visible in our tracking
                            columnVisibility[col.field] = true;

                            return {
                                headerName: col.title || col.field,
                                field: col.field,
                                sortable: true,
                                filter: true,
                                resizable: true,
                                // Set minimum width to improve rendering performance
                                minWidth: 100,
                                // Choose appropriate filters based on data type
                                filterParams: getFilterParams(col.type),
                                // Add tooltips for cell values
                                tooltipField: col.field
                            };
                        });

                        // Generate quick links
                        generateQuickLinks();

                        // Initialize AG Grid
                        initGrid();
                    } else {
                        $("#status").text("Viga: Veergude andmeid ei saadud");
                        $("#loading-overlay").hide();
                    }
                },
                error: function(xhr, status, error) {
                    $("#status").text("Viga: " + error);
                    $("#loading-overlay").hide();
                }
            });
        }

        // Get filter parameters based on column type
        function getFilterParams(type) {
            if (type === 'integer' || type === 'numeric' || type === 'double precision' ||
                type === 'real' || type === 'decimal') {
                return {
                    filterOptions: ['equals', 'lessThan', 'greaterThan', 'inRange'],
                    maxNumConditions: 1
                };
            } else if (type === 'date' || type === 'timestamp' || type === 'timestamp with time zone') {
                return {
                    filterOptions: ['equals', 'lessThan', 'greaterThan', 'inRange'],
                    comparator: dateComparator,
                    maxNumConditions: 1
                };
            } else {
                return {
                    filterOptions: ['contains', 'equals', 'startsWith', 'endsWith'],
                    maxNumConditions: 1,
                    suppressAndOrCondition: true
                };
            }
        }

        // Date comparator for filtering
        function dateComparator(filterDate, cellValue) {
            if (!cellValue) return -1;
            const cellDate = new Date(cellValue);
            if (cellDate < filterDate) return -1;
            if (cellDate > filterDate) return 1;
            return 0;
        }

        // Initialize AG Grid
        function initGrid() {
            // Create grid options
            const gridOptions = {
                defaultColDef: {
                    flex: 1,
                    minWidth: 100,
                    resizable: true,
                    sortable: true,
                    filter: true
                },
                columnDefs: columnDefs,
                rowModelType: 'infinite',  // Use infinite row model for virtualization
                infiniteInitialRowCount: 1000, // Initial placeholder row count
                cacheBlockSize: 100, // Number of rows to load at a time
                maxBlocksInCache: 10, // Maximum number of blocks to keep loaded
                enableCellTextSelection: true,
                getRowId: function(params) {
                    // Use row index as ID - adjust if you have a better unique identifier
                    return params.data.id || params.node.rowIndex;
                },
                // Add tooltip component for better UX
                tooltipShowDelay: 300,
                tooltipInteraction: true,
                // Improve performance with these settings
                suppressAnimationFrame: true,
                enableRangeSelection: false,
                suppressMovableColumns: false,
                suppressFieldDotNotation: true,
                // Event handlers
                onFirstDataRendered: onFirstDataRendered,
                onGridReady: onGridReady,
                onFilterChanged: onFilterChanged,
                onSortChanged: onSortChanged
            };

            // Create the grid
            new agGrid.Grid(document.getElementById('data-table'), gridOptions);
        }

        // Handle grid ready event
        function onGridReady(params) {
            gridApi = params.api;

            // Set a datasource for infinite scrolling
            const dataSource = {
                getRows: function(params) {
                    console.log('Asking for ' + params.startRow + ' to ' + params.endRow);

                    // Show loading indicator for initial load
                    if (params.startRow === 0) {
                        $("#loading-overlay").show();
                    }

                    // Build query parameters
                    const queryParams = {
                        start_row: params.startRow,
                        end_row: params.endRow
                    };

                    // Add sorting if present
                    if (params.sortModel && params.sortModel.length > 0) {
                        queryParams.sort_field = params.sortModel[0].colId;
                        queryParams.sort_dir = params.sortModel[0].sort;
                    }

                    // Add search term if present
                    if (searchTerm) {
                        queryParams.search = searchTerm;
                    }

                    // Add filters if present
                    if (params.filterModel && Object.keys(params.filterModel).length > 0) {
                        queryParams.filter_model = JSON.stringify(params.filterModel);
                    }

                    $.ajax({
                        url: "/api/v1/table/data",
                        method: "GET",
                        data: queryParams,
                        dataType: "json",
                        success: function(response) {
                            // Update status
                            $("#status").text(response.rowCount + " kirjet");

                            // Check if we have more rows
                            const lastRow = response.rowCount <= response.endRow ? response.rowCount : -1;

                            // Provide the data to the grid
                            params.successCallback(response.rowData, lastRow);

                            // Hide loading overlay
                            $("#loading-overlay").hide();
                        },
                        error: function(xhr, status, error) {
                            console.error("Error loading data:", error);
                            $("#status").text("Viga: " + error);
                            params.failCallback();
                            $("#loading-overlay").hide();
                        }
                    });
                }
            };

            // Set the datasource
            gridApi.setDatasource(dataSource);

            // Fit columns to available width
            setTimeout(function() {
                gridApi.sizeColumnsToFit();
            }, 100);

            // Update theme if dark mode is active
            if (isDarkMode) {
                updateTheme();
            }

            // Update font size
            updateFontSize();
        }

        // Handle first data rendered
        function onFirstDataRendered(params) {
            // Auto-size columns for better initial view
            gridApi.autoSizeColumns();

            // Size columns to fit the viewport after auto-sizing
            setTimeout(function() {
                gridApi.sizeColumnsToFit();
            }, 200);
        }

        // Handle filter changes
        function onFilterChanged() {
            // Update row count in status bar
            const displayedRowCount = gridApi.getDisplayedRowCount();
            $("#status").text(displayedRowCount + " kirjet (filtreeritud)");
        }

        // Handle sort changes
        function onSortChanged() {
            // Refresh data with new sort order
            gridApi.refreshInfiniteCache();
        }

        // Update font size
        function updateFontSize() {
            document.documentElement.style.setProperty('--ag-font-size', currentFontSize + 'px');
            if (gridApi) {
                gridApi.refreshCells({ force: true });
            }
        }

        // Update theme (light/dark mode)
        function updateTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                $("body").addClass("bg-gray-900").removeClass("bg-gray-50");
                $(".card, .dropdown-menu, .loading-card, .filter-panel").addClass("bg-gray-800 border-gray-700").removeClass("bg-white border-gray-100");
                $(".input-control, .filter-select, .filter-input").addClass("bg-gray-700 border-gray-600 text-white").removeClass("bg-white border-gray-200");
                $(".btn-secondary").addClass("bg-gray-700 text-gray-200 border-gray-600").removeClass("bg-white text-gray-700 border-gray-200");
                $(".dropdown-item, .dropdown-title, .dropdown-section-title, .filter-group-title").addClass("text-gray-300").removeClass("text-gray-700");
                $(".dropdown-divider").addClass("bg-gray-700").removeClass("bg-gray-200");
                $(".status-chip").addClass("bg-gray-700 text-gray-300").removeClass("bg-gray-100 text-gray-600");
                $(".dropdown-button, .quick-link").addClass("bg-gray-700 text-gray-300").removeClass("bg-gray-100 text-gray-700");
            } else {
                document.body.classList.remove('dark-mode');
                $("body").addClass("bg-gray-50").removeClass("bg-gray-900");
                $(".card, .dropdown-menu, .loading-card, .filter-panel").addClass("bg-white border-gray-100").removeClass("bg-gray-800 border-gray-700");
                $(".input-control, .filter-select, .filter-input").addClass("bg-white border-gray-200 text-gray-900").removeClass("bg-gray-700 border-gray-600 text-white");
                $(".btn-secondary").addClass("bg-white text-gray-700 border-gray-200").removeClass("bg-gray-700 text-gray-200 border-gray-600");
                $(".dropdown-item, .dropdown-title, .dropdown-section-title, .filter-group-title").addClass("text-gray-700").removeClass("text-gray-300");
                $(".dropdown-divider").addClass("bg-gray-200").removeClass("bg-gray-700");
                $(".status-chip").addClass("bg-gray-100 text-gray-600").removeClass("bg-gray-700 text-gray-300");
                $(".dropdown-button, .quick-link").addClass("bg-gray-100 text-gray-700").removeClass("bg-gray-700 text-gray-300");
            }

            if (gridApi) {
                gridApi.refreshCells({ force: true });
            }
        }

        // Generate quick links for columns
        function generateQuickLinks() {
            if (!columnDefs || columnDefs.length === 0) return;

            const quickLinksContainer = $("#column-quick-links");
            quickLinksContainer.empty();

            // Add all columns as quick links (or limit to a reasonable number)
            const maxLinks = Math.min(24, columnDefs.length); // Grid layout will organize these
            for (let i = 0; i < maxLinks; i++) {
                const column = columnDefs[i];
                const linkElement = $("<div>")
                    .addClass("quick-link")
                    .text(column.headerName)
                    .attr("data-field", column.field)
                    .click(function() {
                        scrollToColumn(column.field);
                        $("#links-dropdown-menu").removeClass("show");
                    });

                quickLinksContainer.append(linkElement);
            }
        }

        // Scroll to a specific column
        function scrollToColumn(fieldName) {
            if (!gridApi) return;

            // Get column instance
            const column = gridApi.getColumnDef(fieldName);
            if (column) {
                // Ensure column is visible
                gridApi.ensureColumnVisible(fieldName);

                // Optional: highlight the column briefly
                gridApi.flashCells({
                    columns: [fieldName],
                    rowNodes: gridApi.getDisplayedRowAtIndex(0) ? [gridApi.getDisplayedRowAtIndex(0)] : []
                });
            }
        }

        // Show column visibility modal
        function showColumnVisibilityModal() {
            if (!columnDefs || columnDefs.length === 0) return;

            // Build checkboxes for all columns
            const container = $("#column-checkboxes");
            container.empty();

            columnDefs.forEach(function(col) {
                const isVisible = columnVisibility[col.field];

                const checkbox = $(`
                    <div class="flex items-center">
                        <input type="checkbox" id="col-${col.field}"
                            data-field="${col.field}"
                            class="column-toggle mr-2"
                            ${isVisible ? 'checked' : ''}>
                        <label for="col-${col.field}" class="text-sm">${col.headerName}</label>
                    </div>
                `);

                container.append(checkbox);
            });

            // Show the modal
            $("#column-modal").removeClass("hidden");
        }

        // Apply column visibility changes
        function applyColumnVisibility() {
            if (!gridApi) return;

            // Get checked/unchecked state from checkboxes
            $(".column-toggle").each(function() {
                const field = $(this).data('field');
                const isVisible = $(this).prop('checked');

                // Update local tracking
                columnVisibility[field] = isVisible;

                // Update AG Grid
                gridApi.setColumnVisible(field, isVisible);
            });
        }

        // Search functionality
        function performSearch() {
            searchTerm = $("#search-input").val();

            if (gridApi) {
                // Refresh data with search term
                gridApi.refreshInfiniteCache();
            }
        }

        // Reset search
        function resetSearch() {
            $("#search-input").val('');
            searchTerm = '';

            if (gridApi) {
                // Refresh data without search term
                gridApi.refreshInfiniteCache();
            }
        }

        // Add a filter row
        function addFilterRow() {
            const newRow = $(`
                <div class="filter-row" data-id="${nextFilterId}">
                    <select class="filter-select filter-field">
                        <option value="">Vali veerg...</option>
                    </select>

                    <select class="filter-select filter-operator">
                        <option value="contains">Sisaldab</option>
                        <option value="equals">Võrdub</option>
                        <option value="starts">Algab</option>
                        <option value="ends">Lõpeb</option>
                        <option value="greater">Suurem kui</option>
                        <option value="less">Väiksem kui</option>
                    </select>

                    <input type="text" class="filter-input" placeholder="Filtri väärtus">

                    <button class="filter-remove-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);

            $("#filter-container").append(newRow);

            // Add column options to the new filter field
            updateFilterFields();

            nextFilterId++;
        }

        // Update filter fields with column options
        function updateFilterFields() {
            if (!columnDefs || columnDefs.length === 0) return;

            // Clear existing options except the first placeholder
            $(".filter-field").each(function() {
                const placeholder = $(this).children().first();
                $(this).empty().append(placeholder);
            });

            // Add column options to each filter field dropdown
            columnDefs.forEach(function(col) {
                const option = $("<option>")
                    .val(col.field)
                    .text(col.headerName);

                $(".filter-field").each(function() {
                    $(this).append(option.clone());
                });
            });
        }

        // Apply filters
        function applyFilters() {
            // Collect filter conditions
            activeFilters = [];

            $(".filter-row").each(function() {
                const field = $(this).find(".filter-field").val();
                const operator = $(this).find(".filter-operator").val();
                const value = $(this).find(".filter-input").val();

                // Only add if a field is selected and has a value
                if (field && value) {
                    activeFilters.push({
                        field: field,
                        operator: operator,
                        value: value
                    });
                }
            });

            // Apply filters to AG Grid
            if (gridApi && activeFilters.length > 0) {
                const model = {};

                activeFilters.forEach(function(filter) {
                    let filterModel;

                    switch(filter.operator) {
                        case "contains":
                            filterModel = {
                                filterType: 'text',
                                type: 'contains',
                                filter: filter.value
                            };
                            break;
                        case "equals":
                            filterModel = {
                                filterType: 'text',
                                type: 'equals',
                                filter: filter.value
                            };
                            break;
                        case "starts":
                            filterModel = {
                                filterType: 'text',
                                type: 'startsWith',
                                filter: filter.value
                            };
                            break;
                        case "ends":
                            filterModel = {
                                filterType: 'text',
                                type: 'endsWith',
                                filter: filter.value
                            };
                            break;
                        case "greater":
                            filterModel = {
                                filterType: 'number',
                                type: 'greaterThan',
                                filter: parseFloat(filter.value)
                            };
                            break;
                        case "less":
                            filterModel = {
                                filterType: 'number',
                                type: 'lessThan',
                                filter: parseFloat(filter.value)
                            };
                            break;
                    }

                    model[filter.field] = filterModel;
                });

                gridApi.setFilterModel(model);
            } else if (gridApi) {
                // Clear filters
                gridApi.setFilterModel(null);
            }

            // Update status
            const displayedRowCount = gridApi ? gridApi.getDisplayedRowCount() : 0;
            $("#status").text(activeFilters.length > 0 ?
                `Filtreeritud: ${displayedRowCount} kirjet` :
                `${displayedRowCount} kirjet`);

            // Resize table container
            resizeTableContainer();
        }

        // Clear all filters
        function clearFilters() {
            // Reset filter UI
            $("#filter-container").empty();

            // Add a single empty filter row
            nextFilterId = 2; // Reset ID counter
            addFilterRow();

            // Clear active filters
            activeFilters = [];

            // Clear AG Grid filters
            if (gridApi) {
                gridApi.setFilterModel(null);
            }

            // Update status
            if (gridApi) {
                $("#status").text(`${gridApi.getDisplayedRowCount()} kirjet`);
            }
        }

        // Export custom functionality
        function exportToExcel() {
            if (!gridApi) return;

            const params = {
                fileName: 'Suur_Andmetabel_Export.xlsx',
                processCellCallback: function(params) {
                    // Clean up cell values if needed
                    return params.value;
                }
            };

            gridApi.exportDataAsExcel(params);
        }

        // Add a debounce function to improve search performance
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Set up event handlers
        function setupEventHandlers() {
            // Search with debounce
            const debouncedSearch = debounce(performSearch, 300);

            $("#search-button").click(performSearch);
            $("#search-input").on('input', debouncedSearch);

            // Reset search
            $("#reset-button").click(resetSearch);

            // Enter key in search input
            $("#search-input").keypress(function(e) {
                if (e.which == 13) { // Enter key
                    performSearch();
                }
            });

            // Toggle filter panel
            $("#filter-toggle").click(function() {
                $("#filter-panel").toggleClass("show");

                // If showing, update filter field dropdowns with column options
                if ($("#filter-panel").hasClass("show")) {
                    updateFilterFields();
                }

                // Adjust table container height after toggling filter panel
                setTimeout(resizeTableContainer, 100);
            });

            // Add filter row
            $("#add-filter-row").click(function() {
                addFilterRow();
            });

            // Handle remove filter button clicks (using event delegation)
            $("#filter-container").on("click", ".filter-remove-btn", function() {
                $(this).closest(".filter-row").remove();
            });

            // Apply filters
            $("#apply-filters").click(function() {
                applyFilters();
            });

            // Clear filters
            $("#clear-filters").click(function() {
                clearFilters();
            });

            // Save filter (placeholder)
            $("#save-filter").click(function() {
                alert("Filtri salvestamine on arendamisel.");
            });

            // Tööriistad (Tools) buttons
            $("#view-file").click(function() {
                alert("Funktsioon 'Vaata toimikut' on arendamisel.");
                $("#tools-dropdown-menu").removeClass("show");
            });

            $("#virtual-file").click(function() {
                alert("Funktsioon 'Virtuaaltoimik' on arendamisel.");
                $("#tools-dropdown-menu").removeClass("show");
            });

            $("#receipts-report").click(function() {
                alert("Funktsioon 'Laekumiste aruanne' on arendamisel.");
                $("#tools-dropdown-menu").removeClass("show");
            });

            // Settings buttons
            $("#toggle-columns").click(function() {
                showColumnVisibilityModal();
                $("#settings-dropdown-menu").removeClass("show");
            });

            $("#save-column-layout").click(function() {
                alert("Veergude paigutuse salvestamine on arendamisel.");
                $("#settings-dropdown-menu").removeClass("show");
            });

            // Font size controls
            $("#font-increase").click(function() {
                if (currentFontSize < 20) {
                    currentFontSize += 1;
                    updateFontSize();
                }
                $("#settings-dropdown-menu").removeClass("show");
            });

            $("#font-decrease").click(function() {
                if (currentFontSize > 11) {
                    currentFontSize -= 1;
                    updateFontSize();
                }
                $("#settings-dropdown-menu").removeClass("show");
            });

            // Toggle dark mode
            $("#toggle-dark-mode").click(function() {
                isDarkMode = !isDarkMode;
                updateTheme();
                $("#settings-dropdown-menu").removeClass("show");
            });

            // Widget buttons
            $("#toggle-compact").click(function() {
                isCompactMode = !isCompactMode;

                // For AG Grid, implement compact mode by changing row height
                if (gridApi) {
                    const rowHeight = isCompactMode ? 30 : 40;
                    gridApi.resetRowHeights();
                    gridApi.setGridOption('rowHeight', rowHeight);
                }

                $("#widgets-dropdown-menu").removeClass("show");
            });

            $("#save-view").click(function() {
                alert("Funktsioon 'Salvesta vaade' on arendamisel.");
                $("#widgets-dropdown-menu").removeClass("show");
            });

            $("#load-view").click(function() {
                alert("Funktsioon 'Lae vaade' on arendamisel.");
                $("#widgets-dropdown-menu").removeClass("show");
            });

            // Column visibility modal
            $("#close-column-modal, #column-modal-backdrop, #cancel-column-changes").click(function() {
                $("#column-modal").addClass("hidden");
            });

            $("#apply-column-changes").click(function() {
                applyColumnVisibility();
                $("#column-modal").addClass("hidden");
            });
        }
    </script>

    <!-- Register Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/static/sw.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
</body>
</html>