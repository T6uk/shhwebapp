<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Table App</title>

    <!-- TailwindCSS - for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery for simplicity -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Tabulator CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

    <style>
        .tabulator {
            font-size: 14px;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            background-color: white;
        }
        .tabulator-header {
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .tabulator-row {
            border-bottom: 1px solid #e2e8f0;
        }
        .tabulator-row.tabulator-row-even {
            background-color: #f8fafc;
        }
        .tabulator-row:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto py-8 px-4">
        <h1 class="text-3xl font-bold mb-6">Big Table App</h1>

        <!-- Toolbar -->
        <div class="bg-white rounded-t-lg shadow p-4 mb-1 flex flex-wrap items-center gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search..."
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Search Button -->
            <button
                id="search-button"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                Search
            </button>

            <!-- Reset Button -->
            <button
                id="reset-button"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500"
            >
                Reset
            </button>

            <!-- Status -->
            <div id="status" class="text-gray-600"></div>
        </div>

        <!-- Table Container -->
        <div id="data-table" class="bg-white rounded-lg shadow h-[75vh]"></div>

        <!-- Pagination -->
        <div class="mt-4 flex justify-between items-center">
            <div>
                <span>Total: <span id="total-records">0</span> records</span>
            </div>
            <div class="flex gap-2">
                <button id="prev-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Previous</button>
                <span id="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                <button id="next-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Next</button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-center font-medium">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let table = null;
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let totalRecords = 0;
        let columns = [];
        let searchTerm = '';

        // Initialize when document is ready
        $(document).ready(function() {
            console.log("Document ready, initializing...");

            // Get columns first
            getColumns();

            // Set up event handlers
            $("#search-button").click(function() {
                searchTerm = $("#search-input").val();
                currentPage = 1; // Reset to first page
                getData();
            });

            $("#reset-button").click(function() {
                $("#search-input").val('');
                searchTerm = '';
                currentPage = 1; // Reset to first page
                getData();
            });

            $("#prev-page").click(function() {
                if (currentPage > 1) {
                    currentPage--;
                    getData();
                }
            });

            $("#next-page").click(function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    getData();
                }
            });

            // Enter key in search input
            $("#search-input").keypress(function(e) {
                if (e.which == 13) { // Enter key
                    $("#search-button").click();
                }
            });

            // Update pagination UI
            function updatePagination() {
                $("#current-page").text(currentPage);
                $("#total-pages").text(totalPages);
                $("#total-records").text(totalRecords);

                // Enable/disable buttons
                $("#prev-page").prop("disabled", currentPage <= 1);
                $("#next-page").prop("disabled", currentPage >= totalPages);
            }

            // Get columns from the API
            function getColumns() {
                console.log("Getting columns...");
                $("#loading-overlay").show();
                $("#status").text("Loading columns...");

                $.ajax({
                    url: "/api/v1/table/columns",
                    method: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("Columns response:", response);

                        if (response && response.columns && response.columns.length > 0) {
                            columns = response.columns.map(function(col) {
                                return {
                                    title: col.title || col.field,
                                    field: col.field,
                                    headerFilter: false
                                };
                            });

                            console.log("Processed columns:", columns);
                            initTable();
                            getData();
                        } else {
                            console.error("No columns received from API");
                            $("#status").text("Error: No columns received from API");
                            $("#loading-overlay").hide();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting columns:", error);
                        $("#status").text("Error loading columns: " + error);
                        $("#loading-overlay").hide();
                    }
                });
            }

            // Initialize the table with columns
            function initTable() {
                console.log("Initializing table with columns:", columns);

                try {
                    // Initialize Tabulator
                    table = new Tabulator("#data-table", {
                        layout: "fitDataTable",
                        columns: columns,
                        pagination: false, // We're handling pagination manually
                        height: "75vh",
                        placeholder: "No Data Available"
                    });

                    console.log("Table initialized");
                } catch (error) {
                    console.error("Error initializing table:", error);
                    $("#status").text("Error initializing table: " + error.message);
                }
            }

            // Get data from the API
            function getData() {
                console.log("Getting data for page " + currentPage + "...");
                $("#loading-overlay").show();
                $("#status").text("Loading data...");

                let url = "/api/v1/table/data?page=" + currentPage + "&size=" + pageSize;

                if (searchTerm) {
                    url += "&search=" + encodeURIComponent(searchTerm);
                }

                console.log("Data URL:", url);

                $.ajax({
                    url: url,
                    method: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("Data response received", response);

                        // Check if we got a valid response
                        if (response && Array.isArray(response.data)) {
                            // Update table data
                            table.setData(response.data);

                            // Update pagination
                            totalRecords = response.total || 0;
                            totalPages = response.last_page || 1;
                            updatePagination();

                            $("#status").text("Loaded " + response.data.length + " records");
                        } else {
                            console.error("Invalid data response:", response);
                            $("#status").text("Error: Invalid data response");
                        }

                        $("#loading-overlay").hide();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting data:", error);
                        $("#status").text("Error loading data: " + error);
                        $("#loading-overlay").hide();
                    }
                });
            }
        });
    </script>
</body>
</html>