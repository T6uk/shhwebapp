<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Table App</title>

    <!-- TailwindCSS - for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery for simplicity -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Tabulator CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .tabulator {
            font-size: 14px;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            background-color: white;
            width: 100%;
            flex-grow: 1;
        }

        .tabulator-header {
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tabulator-row {
            border-bottom: 1px solid #e2e8f0;
        }

        .tabulator-row.tabulator-row-even {
            background-color: #f8fafc;
        }

        .tabulator-row:hover {
            background-color: #f1f5f9;
        }

        #table-container {
            flex: 1; /* This will make it fill the available space */
            position: relative;
            width: 100%;
            overflow: hidden; /* Let Tabulator handle the scrolling */
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-2">
        <!-- Header -->
        <div class="mb-2">
            <h1 class="text-2xl font-bold">Big Table App</h1>
        </div>

        <!-- Toolbar -->
        <div class="bg-white rounded-t-lg shadow p-2 mb-2 flex flex-wrap items-center gap-2">
            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search..."
                    class="w-full px-3 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Search Button -->
            <button
                id="search-button"
                class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                Search
            </button>

            <!-- Reset Button -->
            <button
                id="reset-button"
                class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500"
            >
                Reset
            </button>

            <!-- Status -->
            <div id="status" class="text-gray-600"></div>
        </div>

        <!-- Table Container - will dynamically resize -->
        <div id="table-container" class="rounded-lg shadow">
            <div id="data-table"></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-center font-medium">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let table = null;
        let columns = [];
        let searchTerm = '';

        // Initialize when document is ready
        $(document).ready(function() {
            console.log("Document ready, initializing...");

            // Set the initial table container height
            resizeTableContainer();

            // Handle window resize
            $(window).resize(function() {
                resizeTableContainer();
                if (table) {
                    table.redraw(true); // Force a full redraw on resize
                }
            });

            // Get columns first
            getColumns();

            // Set up event handlers
            $("#search-button").click(function() {
                searchTerm = $("#search-input").val();
                getData();
            });

            $("#reset-button").click(function() {
                $("#search-input").val('');
                searchTerm = '';
                getData();
            });

            // Enter key in search input
            $("#search-input").keypress(function(e) {
                if (e.which == 13) { // Enter key
                    $("#search-button").click();
                }
            });

            // Function to resize the table container
            function resizeTableContainer() {
                const windowHeight = $(window).height();
                const headerHeight = $("h1").outerHeight(true);
                const toolbarHeight = $(".bg-white").outerHeight(true);
                const padding = 40; // Allow for some padding

                const tableHeight = windowHeight - headerHeight - toolbarHeight - padding;
                $("#table-container").css("height", tableHeight + "px");

                console.log(`Resized table: Window: ${windowHeight}px, Table: ${tableHeight}px`);
            }

            // Get columns from the API
            function getColumns() {
                console.log("Getting columns...");
                $("#loading-overlay").show();
                $("#status").text("Loading columns...");

                $.ajax({
                    url: "/api/v1/table/columns",
                    method: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("Columns response:", response);

                        if (response && response.columns && response.columns.length > 0) {
                            columns = response.columns.map(function(col) {
                                return {
                                    title: col.title || col.field,
                                    field: col.field,
                                    headerFilter: false,
                                    resizable: true // Allow column resizing
                                };
                            });

                            console.log("Processed columns:", columns);
                            initTable();
                            getData();
                        } else {
                            console.error("No columns received from API");
                            $("#status").text("Error: No columns received from API");
                            $("#loading-overlay").hide();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting columns:", error);
                        $("#status").text("Error loading columns: " + error);
                        $("#loading-overlay").hide();
                    }
                });
            }

            // Initialize the table with columns
            function initTable() {
                console.log("Initializing table with columns:", columns);

                try {
                    // Initialize Tabulator
                    table = new Tabulator("#data-table", {
                        layout: "fitDataTable", // Ensures columns fit to data and table fits to container
                        columns: columns,
                        height: "100%", // Use 100% height of the container
                        data: [], // Start with empty data
                        virtualDom: true, // Virtual DOM for better performance with large datasets
                        placeholder: "No Data Available",
                        responsiveLayout: false, // Disable responsive layout
                        columnDefaults: {
                            resizable: true // All columns resizable
                        },
                        movableColumns: true, // Allow column reordering
                        tooltips: true, // Show tooltips on cells
                        autoResize: true // Auto resize columns on table resize
                    });

                    console.log("Table initialized");
                } catch (error) {
                    console.error("Error initializing table:", error);
                    $("#status").text("Error initializing table: " + error.message);
                }
            }

            // Get data from the API
            function getData() {
                console.log("Getting all data...");
                $("#loading-overlay").show();
                $("#status").text("Loading data...");

                let url = "/api/v1/table/data";

                if (searchTerm) {
                    url += "?search=" + encodeURIComponent(searchTerm);
                }

                console.log("Data URL:", url);

                $.ajax({
                    url: url,
                    method: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("Data response received with", response.data ? response.data.length : 0, "rows");

                        // Check if we got a valid response
                        if (response && Array.isArray(response.data)) {
                            // Update table data
                            table.setData(response.data);

                            // Update status
                            $("#status").text("Loaded " + response.data.length + " records");
                        } else {
                            console.error("Invalid data response:", response);
                            $("#status").text("Error: Invalid data response");
                        }

                        $("#loading-overlay").hide();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting data:", error);
                        $("#status").text("Error loading data: " + error);
                        $("#loading-overlay").hide();
                    }
                });
            }
        });
    </script>
</body>
</html>