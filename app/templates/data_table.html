{% extends "base.html" %}

{% block title %}{{ table_name }} - Big Data Web App{% endblock %}

{% block head %}
<style>
    .edit-controls {
        display: none;
    }
    tr.editing .edit-controls {
        display: inline-block;
    }
    tr.editing .view-controls {
        display: none;
    }
    .table-container {
        overflow-x: auto;
    }
    .dataTables_length, .dataTables_filter {
        margin-bottom: 15px;
    }
    /* Highlight edited cells */
    td.edited {
        background-color: rgba(255, 255, 0, 0.1);
    }
    /* Make table header sticky */
    .dataTables_scrollHead {
        position: sticky;
        top: 0;
        z-index: 2;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2>{{ table_name }}</h2>
                    <div class="btn-group">
                        <button id="refresh-btn" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button id="export-btn" class="btn btn-outline-success">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button id="column-settings-btn" class="btn btn-outline-secondary">
                            <i class="bi bi-gear"></i> Columns
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                    <div class="table-container">
                        <table id="data-table" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <!-- Table headers will be added dynamically -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Column Settings Modal -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Column Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="column-settings-table">
                        <thead>
                            <tr>
                                <th>Visible</th>
                                <th>Column Name</th>
                                <th>Type</th>
                                <th>Order</th>
                            </tr>
                        </thead>
                        <tbody id="column-settings-body">
                            <!-- Column settings will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-column-settings">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let dataTable;
let tableColumns = [];
let visibleColumns = [];

// Function to store this table in recent tables
function addToRecentTables(tableName) {
    const recentTables = JSON.parse(localStorage.getItem('recentTables') || '[]');
    // Remove if already exists
    const filteredTables = recentTables.filter(t => t !== tableName);
    // Add to front
    filteredTables.unshift(tableName);
    // Keep only 5 most recent
    const limitedTables = filteredTables.slice(0, 5);
    localStorage.setItem('recentTables', JSON.stringify(limitedTables));
}

// Helper function to show errors
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    console.error(message);
}

// Initialize DataTable with first row data for columns
async function initializeWithFirstRow() {
    try {
        // Make a simple request to get the first row of data
        const response = await fetch(`/api/table/{{ table_name }}/data?length=1`);
        const data = await response.json();

        if (!data.data || data.data.length === 0) {
            showError('No data found in table. Unable to determine columns.');
            return;
        }

        // Use the first row to determine columns
        const firstRow = data.data[0];
        tableColumns = [];

        // Create column definitions from first row
        Object.keys(firstRow).forEach(key => {
            const value = firstRow[key];
            let dataType = 'text';

            // Simple type detection
            if (typeof value === 'number') {
                dataType = 'number';
            } else if (typeof value === 'boolean') {
                dataType = 'boolean';
            } else if (value instanceof Date) {
                dataType = 'date';
            }

            tableColumns.push({
                name: key,
                type: dataType,
                visible: true
            });
        });

        visibleColumns = [...tableColumns];

        // Initialize table with these columns
        initializeTable();
    } catch (error) {
        showError(`Error fetching data: ${error.message}`);
    }
}

// Initialize DataTable
function initializeTable() {
    try {
        // Add this table to recent tables
        addToRecentTables('{{ table_name }}');

        // Create column definitions for DataTables
        const columnDefs = tableColumns.map(column => ({
            data: column.name,
            title: column.name,
            visible: column.visible !== false
        }));

        // Add actions column
        columnDefs.push({
            data: null,
            title: 'Actions',
            orderable: false,
            defaultContent: `
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary edit-btn view-controls">Edit</button>
                    <button class="btn btn-sm btn-success save-btn edit-controls">Save</button>
                    <button class="btn btn-sm btn-danger cancel-btn edit-controls">Cancel</button>
                </div>
            `
        });

        // Clear any existing DataTable
        if (dataTable) {
            dataTable.destroy();
        }

        // Recreate the table element to avoid any legacy issues
        const tableContainer = document.querySelector('.table-container');
        tableContainer.innerHTML = `
            <table id="data-table" class="table table-striped table-bordered w-100">
                <thead>
                    <tr>
                    ${columnDefs.map(col => `<th>${col.title}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="${columnDefs.length}">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        `;

        // Initialize DataTable
        dataTable = $('#data-table').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: `/api/table/{{ table_name }}/data`,
                error: function(xhr, error, thrown) {
                    showError(`DataTables error: ${error} - ${thrown}`);
                }
            },
            columns: columnDefs,
            dom: 'Blfrtip',
            buttons: [
                'copy', 'csv', 'excel'
            ],
            lengthMenu: [[10, 25, 50, 100, 250], [10, 25, 50, 100, 250]],
            pageLength: 50,
            scrollX: true,
            scrollY: '70vh',
            scrollCollapse: true
        });

        // Attach event handlers
        attachEventHandlers();

    } catch (error) {
        showError(`Error initializing table: ${error.message}`);
    }
}

// Attach event handlers for edit/save/cancel buttons
function attachEventHandlers() {
    // Row editing functionality
    $('#data-table tbody').on('click', '.edit-btn', function() {
        const row = dataTable.row($(this).closest('tr'));
        const rowData = row.data();
        const rowNode = row.node();

        // Mark row as being edited
        $(rowNode).addClass('editing');

        // Replace cell contents with input fields
        $(rowNode).find('td').each(function(cellIndex) {
            // Skip actions column (last column)
            if (cellIndex >= tableColumns.length) return;

            const columnName = tableColumns[cellIndex].name;
            const columnType = tableColumns[cellIndex].type;
            const cellValue = rowData[columnName] || '';

            const originalContent = $(this).html();
            $(this).data('original', originalContent);

            // Create appropriate input based on column type
            let inputField;
            switch(columnType) {
                case 'boolean':
                    inputField = `<select class="form-control form-control-sm edit-field"
                                  data-column="${columnName}">
                                  <option value="true" ${cellValue ? 'selected' : ''}>Yes</option>
                                  <option value="false" ${!cellValue ? 'selected' : ''}>No</option>
                                  </select>`;
                    break;
                case 'date':
                    inputField = `<input type="date" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
                    break;
                case 'number':
                case 'integer':
                    inputField = `<input type="number" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
                    break;
                case 'text':
                    inputField = `<textarea class="form-control form-control-sm edit-field"
                                  data-column="${columnName}" rows="3">${cellValue}</textarea>`;
                    break;
                default:
                    inputField = `<input type="text" class="form-control form-control-sm edit-field"
                                  value="${cellValue}" data-column="${columnName}">`;
            }

            $(this).html(inputField);
        });
    });

    // Cancel editing
    $('#data-table tbody').on('click', '.cancel-btn', function() {
        const row = dataTable.row($(this).closest('tr'));
        const rowNode = row.node();

        // Restore original cell contents
        $(rowNode).find('td').each(function() {
            const originalContent = $(this).data('original');
            if (originalContent) {
                $(this).html(originalContent);
            }
        });

        // Remove editing class
        $(rowNode).removeClass('editing');
    });

    // Save edited row
    $('#data-table tbody').on('click', '.save-btn', function() {
        const row = dataTable.row($(this).closest('tr'));
        const rowData = row.data();
        const rowNode = row.node();

        // Find primary key column and value
        const primaryKeyCol = tableColumns[0].name; // Assume first column is primary key
        const rowId = rowData[primaryKeyCol];

        // Collect updated values
        const updatedData = { ...rowData };
        $(rowNode).find('.edit-field').each(function() {
            const columnName = $(this).data('column');
            let value = $(this).val();

            // Convert value based on column type
            const columnDef = tableColumns.find(col => col.name === columnName);
            if (columnDef) {
                switch(columnDef.type) {
                    case 'boolean':
                        value = value === 'true';
                        break;
                    case 'number':
                        value = parseFloat(value);
                        break;
                    case 'integer':
                        value = parseInt(value, 10);
                        break;
                }
            }

            updatedData[columnName] = value;
        });

        // Send update to server
        fetch(`/api/table/{{ table_name }}/rows/${rowId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Update row data in DataTable
                row.data(updatedData).draw(false);
                $(rowNode).removeClass('editing');

                // Highlight updated cells
                $(rowNode).find('td').each(function(cellIndex) {
                    if (cellIndex === tableColumns.length) return;

                    $(this).addClass('edited');
                    setTimeout(() => {
                        $(this).removeClass('edited');
                    }, 3000);
                });
            } else {
                showError('Error updating row: ' + result.message);
            }
        })
        .catch(error => {
            showError(`Error updating row: ${error.message}`);
        });
    });

    // Column settings button
    document.getElementById('column-settings-btn').addEventListener('click', openColumnSettings);

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', () => {
        dataTable.ajax.reload();
    });
}

// Column settings modal
function openColumnSettings() {
    const settingsBody = document.getElementById('column-settings-body');
    settingsBody.innerHTML = '';

    tableColumns.forEach((column, index) => {
        const row = document.createElement('tr');

        // Visible checkbox
        const visibleCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input column-visible';
        checkbox.dataset.column = column.name;
        checkbox.checked = column.visible;
        visibleCell.appendChild(checkbox);

        // Column name
        const nameCell = document.createElement('td');
        nameCell.textContent = column.name;

        // Type
        const typeCell = document.createElement('td');
        typeCell.textContent = column.type;

        // Order
        const orderCell = document.createElement('td');
        const orderInput = document.createElement('input');
        orderInput.type = 'number';
        orderInput.className = 'form-control form-control-sm column-order';
        orderInput.dataset.column = column.name;
        orderInput.value = index;
        orderInput.min = 0;
        orderCell.appendChild(orderInput);

        row.appendChild(visibleCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(orderCell);

        settingsBody.appendChild(row);
    });

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('columnSettingsModal'));
    modal.show();

    // Save settings button
    document.getElementById('save-column-settings').addEventListener('click', saveColumnSettings);
}

function saveColumnSettings() {
    // Update column visibility and order
    const visibilityCheckboxes = document.querySelectorAll('.column-visible');
    const orderInputs = document.querySelectorAll('.column-order');

    // Update tableColumns array with new settings
    visibilityCheckboxes.forEach(checkbox => {
        const columnName = checkbox.dataset.column;
        const column = tableColumns.find(col => col.name === columnName);
        if (column) {
            column.visible = checkbox.checked;
        }
    });

    // Create array of {name, order} objects
    const columnOrders = Array.from(orderInputs).map(input => ({
        name: input.dataset.column,
        order: parseInt(input.value, 10)
    }));

    // Sort by order
    columnOrders.sort((a, b) => a.order - b.order);

    // Reorder tableColumns array
    tableColumns = columnOrders.map(item =>
        tableColumns.find(col => col.name === item.name)
    );

    // Update visible columns
    visibleColumns = tableColumns.filter(col => col.visible);

    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal'));
    modal.hide();

    // Reinitialize table with new column settings
    initializeTable();
}

// Initialize on page load - start by fetching first row to get columns
document.addEventListener('DOMContentLoaded', initializeWithFirstRow);
</script>
{% endblock %}