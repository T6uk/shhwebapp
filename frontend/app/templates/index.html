{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Data Dashboard</h1>
        <p class="text-gray-600">Interactive data viewer for PostgreSQL database</p>
    </header>

    <!-- Toolbar Section -->
    <div class="bg-white shadow rounded-lg mb-6 p-4">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- Column Selector -->
            <div class="flex-1 min-w-[300px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Visible Columns</label>
                <div class="relative">
                    <select id="column-selector" class="column-selector w-full p-2 border rounded-md" multiple
                            x-data="{}" @change="updateVisibleColumns($event)">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Search -->
            <div class="flex-1 min-w-[300px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search-input" class="w-full p-2 border rounded-md"
                       placeholder="Search across all columns"
                       x-data="{}" @input="debounceSearch($event)">
            </div>

            <!-- Page Size -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Rows per page</label>
                <select id="page-size" class="p-2 border rounded-md"
                        x-data="{}" @change="changePageSize($event)">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="250">250</option>
                    <option value="500">500</option>
                </select>
            </div>

            <!-- Export Buttons -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Export</label>
                <div class="flex gap-2">
                    <button id="export-csv" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                            x-data="{}" @click="exportData('csv')">
                        CSV
                    </button>
                    <button id="export-excel" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                            x-data="{}" @click="exportData('excel')">
                        Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Advanced Filter Section (Hidden by default) -->
        <div id="advanced-filters" class="mt-4 border-t pt-4 hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Advanced Filters</h3>
            <div id="filter-container" class="space-y-3">
                <!-- Filters will be added here dynamically -->
            </div>
            <div class="mt-3 flex gap-2">
                <button id="add-filter" class="bg-gray-200 text-gray-800 px-3 py-1 rounded hover:bg-gray-300"
                        x-data="{}" @click="addFilterRow()">
                    Add Filter
                </button>
                <button id="apply-filters" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                        x-data="{}" @click="applyFilters()">
                    Apply Filters
                </button>
                <button id="clear-filters" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                        x-data="{}" @click="clearFilters()">
                    Clear All
                </button>
            </div>
        </div>

        <!-- Toggle Filters Button -->
        <div class="mt-4 text-center">
            <button id="toggle-filters" class="text-blue-600 hover:text-blue-800"
                    x-data="{ open: false }"
                    @click="open = !open; toggleFilters(open)">
                <span x-show="!open">Show Advanced Filters</span>
                <span x-show="open">Hide Advanced Filters</span>
            </button>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            <p class="mt-2 text-gray-600">Loading data...</p>
        </div>

        <!-- Table Container with fixed height for virtualization -->
        <div id="table-container" class="overflow-x-auto" style="height: 70vh;">
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr id="table-header">
                        <!-- Will be populated dynamically -->
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info" class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">10</span> of <span class="font-medium">0</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                                x-data="{}" @click="changePage('prev')">
                            Previous
                        </button>
                        <div id="page-numbers" class="flex">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                                x-data="{}" @click="changePage('next')">
                            Next
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Info -->
    <div class="mt-4 text-right text-sm text-gray-500">
        <span id="perf-info">Query executed in 0ms</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global state
    const state = {
        columns: [],
        visibleColumns: [],
        currentPage: 1,
        pageSize: 100,
        totalPages: 0,
        totalRecords: 0,
        sortColumn: null,
        sortDirection: 'asc',
        filters: {},
        searchTerm: '',
        debounceTimeout: null,
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
        // Show loading indicator
        toggleLoading(true);

        try {
            // Load columns
            await loadColumns();

            // Initial data load
            await loadData();

            // Setup event listeners
            setupEventListeners();
        } catch (error) {
            console.error('Initialization error:', error);
            alert('Failed to initialize the application. See console for details.');
        } finally {
            toggleLoading(false);
        }
    });

    // Load column definitions
    async function loadColumns() {
        const response = await fetch('/api/columns');
        const data = await response.json();

        state.columns = data.columns;

        // Set initial visible columns (limit to first 15 to avoid overwhelming the UI)
        state.visibleColumns = state.columns.slice(0, 15).map(col => col.name);

        // Populate column selector
        const selector = document.getElementById('column-selector');
        selector.innerHTML = '';

        state.columns.forEach(column => {
            const option = document.createElement('option');
            option.value = column.name;
            option.textContent = column.name;
            option.selected = state.visibleColumns.includes(column.name);
            selector.appendChild(option);
        });
    }

    // Load data from API
    async function loadData() {
        toggleLoading(true);

        try {
            const queryParams = new URLSearchParams({
                page: state.currentPage,
                page_size: state.pageSize,
                visible_columns: state.visibleColumns.join(','),
            });

            if (state.sortColumn) {
                queryParams.append('sort_column', state.sortColumn);
                queryParams.append('sort_direction', state.sortDirection);
            }

            if (state.searchTerm) {
                queryParams.append('search', state.searchTerm);
            }

            if (Object.keys(state.filters).length > 0) {
                queryParams.append('filters', JSON.stringify(state.filters));
            }

            const response = await fetch(`/api/data?${queryParams.toString()}`);
            const data = await response.json();

            // Update state
            state.totalRecords = data.total;
            state.totalPages = data.total_pages;

            // Update table header
            updateTableHeader();

            // Update table body
            updateTableBody(data.data);

            // Update pagination
            updatePagination();

            // Update performance info
            document.getElementById('perf-info').textContent =
                `Query executed in ${(data.execution_time * 1000).toFixed(2)}ms`;

        } catch (error) {
            console.error('Error loading data:', error);
            alert('Failed to load data. See console for details.');
        } finally {
            toggleLoading(false);
        }
    }

    // Update table header based on visible columns
    function updateTableHeader() {
        const header = document.getElementById('table-header');
        header.innerHTML = '';

        state.visibleColumns.forEach(column => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer';
            th.dataset.column = column;

            // Sort indicator
            let sortIndicator = '';
            if (state.sortColumn === column) {
                sortIndicator = state.sortDirection === 'asc' ? ' ▲' : ' ▼';
            }

            th.innerHTML = `<div class="flex items-center justify-between">
                <span>${column}${sortIndicator}</span>
            </div>`;

            // Add click event for sorting
            th.addEventListener('click', () => {
                if (state.sortColumn === column) {
                    // Toggle direction
                    state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // New sort column
                    state.sortColumn = column;
                    state.sortDirection = 'asc';
                }
                loadData();
            });

            header.appendChild(th);
        });
    }

    // Update table body with data
    function updateTableBody(data) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="${state.visibleColumns.length}" class="px-6 py-4 text-center text-gray-500">
                No data available
            </td>`;
            tbody.appendChild(tr);
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            state.visibleColumns.forEach(column => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                td.textContent = row[column] !== null ? row[column] : '';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // Update pagination controls
    function updatePagination() {
        // Update info text
        const start = (state.currentPage - 1) * state.pageSize + 1;
        const end = Math.min(state.currentPage * state.pageSize, state.totalRecords);

        document.getElementById('pagination-info').innerHTML =
            `Showing <span class="font-medium">${start}</span> to <span class="font-medium">${end}</span> of <span class="font-medium">${state.totalRecords}</span> results`;

        // Update page numbers
        const pageNumbers = document.getElementById('page-numbers');
        pageNumbers.innerHTML = '';

        // Determine page range to show
        let startPage = Math.max(1, state.currentPage - 2);
        let endPage = Math.min(state.totalPages, startPage + 4);

        // Adjust start page if needed
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        // First page button if not starting at 1
        if (startPage > 1) {
            const button = createPageButton(1);
            pageNumbers.appendChild(button);

            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700';
                ellipsis.textContent = '...';
                pageNumbers.appendChild(ellipsis);
            }
        }

        // Page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = createPageButton(i);
            pageNumbers.appendChild(button);
        }

        // Last page button if not ending at total pages
        if (endPage < state.totalPages) {
            if (endPage < state.totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700';
                ellipsis.textContent = '...';
                pageNumbers.appendChild(ellipsis);
            }

            const button = createPageButton(state.totalPages);
            pageNumbers.appendChild(button);
        }

        // Update prev/next buttons
        document.getElementById('prev-page').disabled = state.currentPage === 1;
        document.getElementById('next-page').disabled = state.currentPage === state.totalPages;
    }

    // Create a page button for pagination
    function createPageButton(pageNumber) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = state.currentPage === pageNumber
            ? 'relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600'
            : 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50';
        button.textContent = pageNumber;

        button.addEventListener('click', () => {
            state.currentPage = pageNumber;
            loadData();
        });

        return button;
    }

    // Toggle loading indicator
    function toggleLoading(show) {
        const loadingIndicator = document.getElementById('loading-indicator');
        const tableContainer = document.getElementById('table-container');

        if (show) {
            loadingIndicator.classList.remove('hidden');
            tableContainer.classList.add('opacity-50');
        } else {
            loadingIndicator.classList.add('hidden');
            tableContainer.classList.remove('opacity-50');
        }
    }

    // Setup global event listeners
    function setupEventListeners() {
        // Column selector change
        window.updateVisibleColumns = (event) => {
            const select = event.target;
            state.visibleColumns = Array.from(select.selectedOptions).map(opt => opt.value);
            loadData();
        };

        // Page size change
        window.changePageSize = (event) => {
            state.pageSize = parseInt(event.target.value);
            state.currentPage = 1; // Reset to first page
            loadData();
        };

        // Search input
        window.debounceSearch = (event) => {
            clearTimeout(state.debounceTimeout);
            state.debounceTimeout = setTimeout(() => {
                state.searchTerm = event.target.value;
                state.currentPage = 1; // Reset to first page
                loadData();
            }, 300);
        };

        // Pagination
        window.changePage = (direction) => {
            if (direction === 'prev' && state.currentPage > 1) {
                state.currentPage--;
            } else if (direction === 'next' && state.currentPage < state.totalPages) {
                state.currentPage++;
            }
            loadData();
        };

        // Toggle advanced filters
        window.toggleFilters = (show) => {
            const filtersSection = document.getElementById('advanced-filters');
            if (show) {
                filtersSection.classList.remove('hidden');
            } else {
                filtersSection.classList.add('hidden');
            }
        };

        // Add filter row
        window.addFilterRow = () => {
            const container = document.getElementById('filter-container');
            const rowId = `filter-${Date.now()}`;

            const filterRow = document.createElement('div');
            filterRow.id = rowId;
            filterRow.className = 'filter-row flex flex-wrap items-center gap-2';

            // Column select
            const columnSelect = document.createElement('select');
            columnSelect.className = 'p-2 border rounded-md w-1/4';
            columnSelect.innerHTML = '<option value="">Select column</option>';

            state.columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.name;
                option.textContent = column.name;
                columnSelect.appendChild(option);
            });

            // Operator select
            const operatorSelect = document.createElement('select');
            operatorSelect.className = 'p-2 border rounded-md w-1/4';
            operatorSelect.innerHTML = `
                <option value="eq">equals</option>
                <option value="neq">not equals</option>
                <option value="gt">greater than</option>
                <option value="lt">less than</option>
                <option value="gte">greater than or equal</option>
                <option value="lte">less than or equal</option>
                <option value="contains">contains</option>
                <option value="startswith">starts with</option>
                <option value="endswith">ends with</option>
            `;

            // Value input
            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.className = 'p-2 border rounded-md w-1/3';
            valueInput.placeholder = 'Value';

            // Remove button
            const removeButton = document.createElement('button');
            removeButton.className = 'p-2 text-red-600 hover:text-red-800';
            removeButton.innerHTML = '×';
            removeButton.addEventListener('click', () => {
                container.removeChild(filterRow);
            });

            // Add all elements to the row
            filterRow.appendChild(columnSelect);
            filterRow.appendChild(operatorSelect);
            filterRow.appendChild(valueInput);
            filterRow.appendChild(removeButton);

            // Add row to container
            container.appendChild(filterRow);
        };

        // Apply filters
        window.applyFilters = () => {
            const filterRows = document.querySelectorAll('.filter-row');
            state.filters = {};

            filterRows.forEach(row => {
                const columnSelect = row.querySelector('select:first-child');
                const operatorSelect = row.querySelector('select:nth-child(2)');
                const valueInput = row.querySelector('input');

                const column = columnSelect.value;
                const operator = operatorSelect.value;
                const value = valueInput.value;

                if (column && value) {
                    state.filters[column] = {
                        op: operator,
                        value: value
                    };
                }
            });

            state.currentPage = 1; // Reset to first page
            loadData();
        };

        // Clear filters
        window.clearFilters = () => {
            document.getElementById('filter-container').innerHTML = '';
            state.filters = {};
            state.currentPage = 1; // Reset to first page
            loadData();
        };

        // Export data
        window.exportData = (format) => {
            const queryParams = new URLSearchParams({
                format: format
            });

            if (Object.keys(state.filters).length > 0) {
                queryParams.append('filters', JSON.stringify(state.filters));
            }

            window.open(`/api/data/export?${queryParams.toString()}`, '_blank');
        };
    }
</script>
{% endblock %}